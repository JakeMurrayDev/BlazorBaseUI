@page "/tests/collapsible/server"
@using BlazorBaseUI.Collapsible
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Collapsible Test Page (Server)</PageTitle>

@if (Animated)
{
    <style>
        .animated-panel {
            overflow: hidden;
            transition: height 200ms ease-out, opacity 200ms ease-out;
        }

        .animated-panel[data-closed] {
            height: 0;
            opacity: 0;
        }

        .animated-panel[data-open] {
            height: var(--collapsible-panel-height);
            opacity: 1;
        }

        .animated-panel[data-starting-style] {
            height: 0;
            opacity: 0;
        }

        .animated-panel[data-ending-style] {
            height: 0;
            opacity: 0;
        }
    </style>
}

<div data-testid="test-container" data-interactive="@RendererInfo.IsInteractive.ToString().ToLowerInvariant()">
    <CollapsibleRoot
        @bind-Open="isOpen"
        DefaultOpen="@DefaultOpen"
        Disabled="@Disabled"
        OnOpenChange="HandleOpenChange"
        data-testid="collapsible-root">
        <CollapsibleTrigger data-testid="collapsible-trigger">
            Toggle
        </CollapsibleTrigger>
        <CollapsiblePanel
            id="@PanelId"
            data-testid="collapsible-panel"
            KeepMounted="@KeepMounted"
            HiddenUntilFound="@HiddenUntilFound"
            ClassValue="@(Animated ? _ => "animated-panel" : null)">
            <div data-testid="panel-content" style="padding: 16px;">
                <p>This is the collapsible panel content.</p>
                <p>It contains multiple lines for height testing.</p>
            </div>
        </CollapsiblePanel>
    </CollapsibleRoot>

    <div data-testid="state-display" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;">
        <div>Open: <span data-testid="open-state">@isOpen.ToString().ToLowerInvariant()</span></div>
        <div>Change Count: <span data-testid="change-count">@changeCount</span></div>
        <div>Last Event Canceled: <span data-testid="last-canceled">@lastCanceled.ToString().ToLowerInvariant()</span></div>
        <div>Last Event Reason: <span data-testid="last-reason">@lastReason</span></div>
        <div>Last Event Open: <span data-testid="last-open">@lastOpen.ToString().ToLowerInvariant()</span></div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery(Name = "keepMounted")]
    public bool KeepMounted { get; set; }

    [SupplyParameterFromQuery(Name = "hiddenUntilFound")]
    public bool HiddenUntilFound { get; set; }

    [SupplyParameterFromQuery(Name = "animated")]
    public bool Animated { get; set; }

    [SupplyParameterFromQuery(Name = "disabled")]
    public bool Disabled { get; set; }

    [SupplyParameterFromQuery(Name = "defaultOpen")]
    public bool DefaultOpen { get; set; }

    [SupplyParameterFromQuery(Name = "panelId")]
    public string? PanelId { get; set; }

    private bool isOpen;
    private int changeCount;
    private bool lastCanceled;
    private string lastReason = "";
    private bool lastOpen;

    protected override void OnInitialized()
    {
        isOpen = DefaultOpen;
    }

    private void HandleOpenChange(CollapsibleOpenChangeEventArgs args)
    {
        changeCount++;
        lastCanceled = args.Canceled;
        lastReason = args.Reason.ToString();
        lastOpen = args.Open;
    }
}
