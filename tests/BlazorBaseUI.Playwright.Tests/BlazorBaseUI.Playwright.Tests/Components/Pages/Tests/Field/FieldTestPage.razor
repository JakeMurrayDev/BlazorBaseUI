@page "/tests/field/server"
@using BlazorBaseUI.Field
@using BlazorBaseUI.Form
@using BlazorBaseUI.Fieldset
@using BlazorBaseUI.Checkbox
@using BlazorBaseUI.Switch
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Field Test Page (Server)</PageTitle>

<div data-testid="test-container" data-interactive="@RendererInfo.IsInteractive.ToString().ToLowerInvariant()">
    @switch (Scenario)
    {
        case "basic":
            @RenderBasicField()
            break;
        case "validation-onsubmit":
            @RenderValidationOnSubmit()
            break;
        case "validation-onchange":
            @RenderValidationOnChange()
            break;
        case "validation-onblur":
            @RenderValidationOnBlur()
            break;
        case "style-hooks":
            @RenderStyleHooks()
            break;
        case "computed-validity":
            @RenderComputedValidity()
            break;
        case "actions-ref":
            @RenderActionsRef()
            break;
        case "label-nonnative":
            @RenderLabelNonNative()
            break;
        case "field-item-checkbox":
            @RenderFieldItemCheckbox()
            break;
        case "field-item-radio":
            @RenderFieldItemRadio()
            break;
        case "field-error-submit":
            @RenderFieldErrorSubmit()
            break;
        case "field-error-match":
            @RenderFieldErrorMatch()
            break;
        case "field-error-custom":
            @RenderFieldErrorCustom()
            break;
        case "field-validity-onsubmit":
            @RenderFieldValidityOnSubmit()
            break;
        case "field-validity-onblur":
            @RenderFieldValidityOnBlur()
            break;
        case "field-validity-errors-string":
            @RenderFieldValidityErrorsString()
            break;
        case "field-validity-errors-array":
            @RenderFieldValidityErrorsArray()
            break;
        case "async-validation":
            @RenderAsyncValidation()
            break;
        case "unmounted-field":
            @RenderUnmountedField()
            break;
        default:
            @RenderBasicField()
            break;
    }

    <div data-testid="state-display" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;">
        <div>Touched: <span data-testid="touched-state">@touchedState.ToString().ToLowerInvariant()</span></div>
        <div>Dirty: <span data-testid="dirty-state">@dirtyState.ToString().ToLowerInvariant()</span></div>
        <div>Filled: <span data-testid="filled-state">@filledState.ToString().ToLowerInvariant()</span></div>
        <div>Focused: <span data-testid="focused-state">@focusedState.ToString().ToLowerInvariant()</span></div>
        <div>Valid: <span data-testid="valid-state">@validState?.ToString().ToLowerInvariant()</span></div>
        <div>Submit Count: <span data-testid="submit-count">@submitCount</span></div>
        <div>Validation Count: <span data-testid="validation-count">@validationCount</span></div>
        <div>Last Error: <span data-testid="last-error">@lastError</span></div>
    </div>
</div>

@code {
    private RenderFragment RenderBasicField() => @<Form Model="model" ValidationMode="@ResolvedValidationMode">
        <FieldRoot Name="name" Disabled="@Disabled"
                   ClassValue="@(state => state.Touched ? "touched" : "")"
                   data-testid="field-root">
            <FieldLabel data-testid="field-label">Name</FieldLabel>
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            @if (ShowDescription)
            {
                <FieldDescription data-testid="field-description">Enter your name</FieldDescription>
            }
            @if (ShowError)
            {
                <FieldError data-testid="field-error" />
            }
        </FieldRoot>
    </Form>;

    private RenderFragment RenderValidationOnSubmit() => @<Form Model="model" ValidationMode="ValidationMode.OnSubmit" OnInvalidSubmit="HandleInvalidSubmit">
        <FieldRoot Name="name" Validate="ValidateRequired" data-testid="field-root">
            <FieldLabel data-testid="field-label">Name</FieldLabel>
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldError data-testid="field-error" />
        </FieldRoot>
        @if (ShowSecondField)
        {
            <FieldRoot Name="email" Validate="ValidateRequired" data-testid="field-root-2">
                <FieldLabel data-testid="field-label-2">Email</FieldLabel>
                <FieldControl @bind-Value="model.Email" data-testid="field-control-2" />
                <FieldError data-testid="field-error-2" />
            </FieldRoot>
        }
        <button type="submit" data-testid="submit-button">Submit</button>
    </Form>;

    private RenderFragment RenderValidationOnChange() => @<Form Model="model" ValidationMode="ValidationMode.OnChange">
        <FieldRoot Name="name" Validate="ValidateRequired" data-testid="field-root">
            <FieldLabel data-testid="field-label">Name</FieldLabel>
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldError data-testid="field-error" />
        </FieldRoot>
        <button type="submit" data-testid="submit-button">Submit</button>
    </Form>;

    private RenderFragment RenderValidationOnBlur() => @<Form Model="model" ValidationMode="ValidationMode.OnBlur">
        <FieldRoot Name="name" Validate="ValidateRequired" data-testid="field-root">
            <FieldLabel data-testid="field-label">Name</FieldLabel>
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldError data-testid="field-error" />
        </FieldRoot>
        <button type="submit" data-testid="submit-button">Submit</button>
        <input data-testid="other-input" type="text" placeholder="Other" />
    </Form>;

    private RenderFragment RenderStyleHooks() => @<Form Model="model" ValidationMode="@ResolvedValidationMode">
        <FieldRoot Name="name" data-testid="field-root">
            <FieldLabel data-testid="field-label">Name</FieldLabel>
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
        </FieldRoot>
        <input data-testid="other-input" type="text" placeholder="Other" />
    </Form>;

    private RenderFragment RenderComputedValidity() => @<Form Model="model" ValidationMode="ValidationMode.OnBlur">
        <FieldRoot Name="name" Validate="ValidateRequired" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldError data-testid="field-error" />
        </FieldRoot>
        <input data-testid="other-input" type="text" placeholder="Other" />
    </Form>;

    private RenderFragment RenderActionsRef() =>
    @<Form Model="model">
        <FieldRoot Name="name" Validate="ValidateRequired" ActionsRef="@(a => fieldActions = a)" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldError data-testid="field-error" />
        </FieldRoot>
        <button type="button" data-testid="validate-button" @onclick="HandleValidateField">Validate</button>
    </Form>;

    private RenderFragment RenderLabelNonNative() => @<Form Model="model">
        <FieldRoot Name="name" data-testid="field-root">
            <FieldLabel NativeLabel="false" data-testid="field-label">Name</FieldLabel>
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
        </FieldRoot>
    </Form>;

    private RenderFragment RenderFieldItemCheckbox() => @<Form Model="model">
        <FieldRoot Name="agree" Disabled="@Disabled" data-testid="field-root">
            <FieldItem Disabled="@Disabled" data-testid="field-item">
                <CheckboxRoot @bind-Checked="agreeChecked" data-testid="field-control">
                    <CheckboxIndicator data-testid="checkbox-indicator" />
                </CheckboxRoot>
                <FieldLabel data-testid="field-label">I agree</FieldLabel>
            </FieldItem>
        </FieldRoot>
    </Form>;

    private RenderFragment RenderFieldItemRadio() => @<Form Model="model">
        <FieldRoot Name="choice" Disabled="@Disabled" data-testid="field-root">
            <FieldItem Disabled="@Disabled" data-testid="field-item-1">
                <input type="radio" name="choice" data-testid="field-control-1" />
                <FieldLabel data-testid="field-label-1">Option A</FieldLabel>
            </FieldItem>
            <FieldItem Disabled="@Disabled" data-testid="field-item-2">
                <input type="radio" name="choice" data-testid="field-control-2" />
                <FieldLabel data-testid="field-label-2">Option B</FieldLabel>
            </FieldItem>
        </FieldRoot>
    </Form>;

    private RenderFragment RenderFieldErrorSubmit() => @<Form Model="model" ValidationMode="ValidationMode.OnSubmit" OnInvalidSubmit="HandleInvalidSubmit">
        <FieldRoot Name="name" Validate="ValidateRequired" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldError data-testid="field-error" />
        </FieldRoot>
        <button type="submit" data-testid="submit-button">Submit</button>
    </Form>;

    private RenderFragment RenderFieldErrorMatch() => @<Form Model="model" ValidationMode="ValidationMode.OnSubmit" OnInvalidSubmit="HandleInvalidSubmit">
        <FieldRoot Name="name" Validate="ValidateRequired" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldError MatchValidity="@MatchValidity" data-testid="field-error-match" />
            <FieldError data-testid="field-error" />
        </FieldRoot>
        <button type="submit" data-testid="submit-button">Submit</button>
    </Form>;

    private RenderFragment RenderFieldErrorCustom() => @<Form Model="model" ValidationMode="ValidationMode.OnSubmit" OnInvalidSubmit="HandleInvalidSubmit">
        <FieldRoot Name="name" Validate="ValidateCustom" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldError MatchValidity="customError" data-testid="field-error-custom" />
            <FieldError data-testid="field-error" />
        </FieldRoot>
        <button type="submit" data-testid="submit-button">Submit</button>
    </Form>;

    private RenderFragment RenderFieldValidityOnSubmit() => @<Form Model="model" ValidationMode="ValidationMode.OnSubmit" OnInvalidSubmit="HandleInvalidSubmit">
        <FieldRoot Name="name" Validate="ValidateRequired" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldValidity Context="validity">
                <div data-testid="validity-valid">@validity.State.Valid?.ToString().ToLowerInvariant()</div>
                <div data-testid="validity-error">@validity.Error</div>
                <div data-testid="validity-errors-count">@validity.Errors.Length</div>
            </FieldValidity>
        </FieldRoot>
        <button type="submit" data-testid="submit-button">Submit</button>
    </Form>;

    private RenderFragment RenderFieldValidityOnBlur() => @<Form Model="model" ValidationMode="ValidationMode.OnBlur">
        <FieldRoot Name="name" Validate="ValidateRequired" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldValidity Context="validity">
                <div data-testid="validity-valid">@validity.State.Valid?.ToString().ToLowerInvariant()</div>
                <div data-testid="validity-error">@validity.Error</div>
                <div data-testid="validity-errors-count">@validity.Errors.Length</div>
            </FieldValidity>
        </FieldRoot>
        <input data-testid="other-input" type="text" placeholder="Other" />
    </Form>;

    private RenderFragment RenderFieldValidityErrorsString() => @<Form Model="model" ValidationMode="ValidationMode.OnBlur">
        <FieldRoot Name="name" Validate="ValidateWithSingleError" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldValidity Context="validity">
                <div data-testid="validity-valid">@validity.State.Valid?.ToString().ToLowerInvariant()</div>
                <div data-testid="validity-error">@validity.Error</div>
                <div data-testid="validity-errors-count">@validity.Errors.Length</div>
            </FieldValidity>
        </FieldRoot>
        <input data-testid="other-input" type="text" placeholder="Other" />
    </Form>;

    private RenderFragment RenderFieldValidityErrorsArray() => @<Form Model="model" ValidationMode="ValidationMode.OnBlur">
        <FieldRoot Name="name" Validate="ValidateWithMultipleErrors" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldValidity Context="validity">
                <div data-testid="validity-valid">@validity.State.Valid?.ToString().ToLowerInvariant()</div>
                <div data-testid="validity-error">@validity.Error</div>
                <div data-testid="validity-errors-count">@validity.Errors.Length</div>
                @foreach (var err in validity.Errors)
                {
                    <div data-testid="validity-error-item">@err</div>
                }
            </FieldValidity>
        </FieldRoot>
        <input data-testid="other-input" type="text" placeholder="Other" />
    </Form>;

    private RenderFragment RenderAsyncValidation() => @<Form Model="model" ValidationMode="ValidationMode.OnBlur">
        <FieldRoot Name="name" Validate="ValidateAsync" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldError data-testid="field-error" />
        </FieldRoot>
        <input data-testid="other-input" type="text" placeholder="Other" />
    </Form>;

    private RenderFragment RenderUnmountedField() => @<Form Model="model" ValidationMode="ValidationMode.OnSubmit" OnInvalidSubmit="HandleInvalidSubmit"
          ActionsRef="@(a => formActions = a)">
        <FieldRoot Name="name" Validate="ValidateRequired" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldError data-testid="field-error" />
        </FieldRoot>
        @if (showSecondFieldRuntime)
        {
            <FieldRoot Name="email" Validate="ValidateRequired" data-testid="field-root-2">
                <FieldControl @bind-Value="model.Email" data-testid="field-control-2" />
                <FieldError data-testid="field-error-2" />
            </FieldRoot>
        }
        <button type="submit" data-testid="submit-button">Submit</button>
        <button type="button" data-testid="toggle-field" @onclick="() => showSecondFieldRuntime = !showSecondFieldRuntime">Toggle Field</button>
        <button type="button" data-testid="validate-all" @onclick="HandleValidateAll">Validate All</button>
    </Form>;

    private sealed class TestFormModel
    {
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string Agree { get; set; } = "";
        public string Choice { get; set; } = "";
    }

    [SupplyParameterFromQuery(Name = "scenario")]
    public string Scenario { get; set; } = "basic";

    [SupplyParameterFromQuery(Name = "disabled")]
    public bool Disabled { get; set; }

    [SupplyParameterFromQuery(Name = "validationMode")]
    public string? ValidationModeParam { get; set; }

    [SupplyParameterFromQuery(Name = "showSecondField")]
    public bool ShowSecondField { get; set; }

    [SupplyParameterFromQuery(Name = "showError")]
    public bool? ShowErrorParam { get; set; }

    private bool ShowError => ShowErrorParam ?? true;

    [SupplyParameterFromQuery(Name = "showDescription")]
    public bool ShowDescription { get; set; }

    [SupplyParameterFromQuery(Name = "matchValidity")]
    public string? MatchValidity { get; set; }

    private ValidationMode ResolvedValidationMode => ValidationModeParam?.ToLowerInvariant() switch
    {
        "onchange" => ValidationMode.OnChange,
        "onblur" => ValidationMode.OnBlur,
        _ => ValidationMode.OnSubmit
    };

    private TestFormModel model = new();
    private bool agreeChecked;
    private bool touchedState;
    private bool dirtyState;
    private bool filledState;
    private bool focusedState;
    private bool? validState;
    private int submitCount;
    private int validationCount;
    private string lastError = "";
    private FieldRootActions? fieldActions;
    private FormActions? formActions;
    private bool showSecondFieldRuntime = true;

    private Task<string[]?> ValidateRequired(object? value)
    {
        validationCount++;
        var strValue = value?.ToString() ?? "";
        if (string.IsNullOrWhiteSpace(strValue))
            return Task.FromResult<string[]?>(["This field is required"]);
        return Task.FromResult<string[]?>(null);
    }

    private Task<string[]?> ValidateCustom(object? value)
    {
        validationCount++;
        var strValue = value?.ToString() ?? "";
        if (string.IsNullOrWhiteSpace(strValue))
            return Task.FromResult<string[]?>(["Custom validation error"]);
        return Task.FromResult<string[]?>(null);
    }

    private Task<string[]?> ValidateWithSingleError(object? value)
    {
        validationCount++;
        var strValue = value?.ToString() ?? "";
        if (string.IsNullOrWhiteSpace(strValue))
            return Task.FromResult<string[]?>(["Single error message"]);
        return Task.FromResult<string[]?>(null);
    }

    private Task<string[]?> ValidateWithMultipleErrors(object? value)
    {
        validationCount++;
        var strValue = value?.ToString() ?? "";
        if (string.IsNullOrWhiteSpace(strValue))
            return Task.FromResult<string[]?>(["Error one", "Error two", "Error three"]);
        return Task.FromResult<string[]?>(null);
    }

    private async Task<string[]?> ValidateAsync(object? value)
    {
        validationCount++;
        await Task.Delay(100);
        var strValue = value?.ToString() ?? "";
        if (string.IsNullOrWhiteSpace(strValue))
            return ["Async validation failed"];
        return null;
    }

    private void HandleInvalidSubmit(Microsoft.AspNetCore.Components.Forms.EditContext context)
    {
        submitCount++;
    }

    private async Task HandleValidateField()
    {
        if (fieldActions is not null)
            await fieldActions.ValidateAsync();
    }

    private async Task HandleValidateAll()
    {
        if (formActions is not null)
            await formActions.ValidateAsync();
    }
}
