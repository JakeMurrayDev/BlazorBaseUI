@page "/tests/checkboxgroup/server"
@using BlazorBaseUI.Checkbox
@using BlazorBaseUI.CheckboxGroup
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>CheckboxGroup Test Page (Server)</PageTitle>

<style>
    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .checkbox-root {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border: 2px solid #666;
        border-radius: 4px;
        background-color: white;
        cursor: pointer;
        position: relative;
    }
    .checkbox-root[data-checked] {
        background-color: #4caf50;
        border-color: #4caf50;
    }
    .checkbox-root[data-indeterminate] {
        background-color: #2196f3;
        border-color: #2196f3;
    }
    .checkbox-root[data-disabled] {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .checkbox-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        color: white;
        font-size: 14px;
        font-weight: bold;
    }
    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
</style>

<div data-testid="test-container" data-interactive="@RendererInfo.IsInteractive.ToString().ToLowerInvariant()">
    @if (ShowForm)
    {
        <form data-testid="test-form" @onsubmit="HandleSubmit" @onsubmit:preventDefault>
            @RenderCheckboxGroup()
            <button type="submit" data-testid="submit-button">Submit</button>
            <div data-testid="form-data">@formData</div>
        </form>
    }
    else
    {
        @RenderCheckboxGroup()
    }

    <div data-testid="state-display" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;">
        <div>Value: <span data-testid="value-state">@(string.Join(",", currentValue ?? []))</span></div>
        <div>Change Count: <span data-testid="change-count">@changeCount</span></div>
    </div>

    <button data-testid="outside-button" style="margin-top: 10px;">Outside Button</button>
    <button data-testid="toggle-red" @onclick="ToggleRed" style="margin-top: 10px;">Toggle Red</button>
    <button data-testid="select-all" @onclick="SelectAll" style="margin-top: 10px;">Select All</button>
    <button data-testid="clear-all" @onclick="ClearAll" style="margin-top: 10px;">Clear All</button>
</div>

@code {
    [SupplyParameterFromQuery(Name = "defaultValue")]
    public string? DefaultValueQuery { get; set; }

    [SupplyParameterFromQuery(Name = "value")]
    public string? ValueQuery { get; set; }

    [SupplyParameterFromQuery(Name = "disabled")]
    public bool Disabled { get; set; }

    [SupplyParameterFromQuery(Name = "showForm")]
    public bool ShowForm { get; set; }

    [SupplyParameterFromQuery(Name = "showParent")]
    public bool ShowParent { get; set; }

    [SupplyParameterFromQuery(Name = "name")]
    public string? Name { get; set; }

    private string[]? currentValue;
    private int changeCount;
    private string formData = "";

    private string[] AllValues => ["red", "green", "blue"];

    protected override void OnInitialized()
    {
        if (!string.IsNullOrEmpty(DefaultValueQuery))
        {
            currentValue = DefaultValueQuery.Split(',', StringSplitOptions.RemoveEmptyEntries);
        }
        else if (!string.IsNullOrEmpty(ValueQuery))
        {
            currentValue = ValueQuery.Split(',', StringSplitOptions.RemoveEmptyEntries);
        }
        else
        {
            currentValue = [];
        }
    }

    private RenderFragment RenderCheckboxGroup() => __builder =>
    {
        <CheckboxGroup
            @bind-Value="currentValue"
            DefaultValue="@(string.IsNullOrEmpty(DefaultValueQuery) ? null : DefaultValueQuery.Split(',', StringSplitOptions.RemoveEmptyEntries))"
            AllValues="@(ShowParent ? AllValues : null)"
            Disabled="@Disabled"
            OnValueChange="HandleValueChange"
            class="checkbox-group"
            data-testid="checkbox-group">

            @if (ShowParent)
            {
                <div class="checkbox-item">
                    <CheckboxRoot
                        Parent="true"
                        class="checkbox-root"
                        data-testid="parent-checkbox">
                        <CheckboxIndicator class="checkbox-indicator">
                            @if (IsParentIndeterminate())
                            {
                                <text>-</text>
                            }
                            else
                            {
                                <text>&#10003;</text>
                            }
                        </CheckboxIndicator>
                    </CheckboxRoot>
                    <span>Select All</span>
                </div>
            }

            <div class="checkbox-item">
                <CheckboxRoot
                    Name="red"
                    class="checkbox-root"
                    data-testid="checkbox-red">
                    <CheckboxIndicator class="checkbox-indicator">&#10003;</CheckboxIndicator>
                </CheckboxRoot>
                <span>Red</span>
            </div>

            <div class="checkbox-item">
                <CheckboxRoot
                    Name="green"
                    class="checkbox-root"
                    data-testid="checkbox-green">
                    <CheckboxIndicator class="checkbox-indicator">&#10003;</CheckboxIndicator>
                </CheckboxRoot>
                <span>Green</span>
            </div>

            <div class="checkbox-item">
                <CheckboxRoot
                    Name="blue"
                    class="checkbox-root"
                    data-testid="checkbox-blue">
                    <CheckboxIndicator class="checkbox-indicator">&#10003;</CheckboxIndicator>
                </CheckboxRoot>
                <span>Blue</span>
            </div>
        </CheckboxGroup>
    };

    private bool IsParentIndeterminate()
    {
        var count = currentValue?.Length ?? 0;
        return count > 0 && count < AllValues.Length;
    }

    private void HandleValueChange(CheckboxGroupValueChangeEventArgs args)
    {
        changeCount++;
    }

    private void ToggleRed() => ToggleValue("red");

    private void ToggleValue(string value)
    {
        var list = (currentValue ?? []).ToList();
        if (list.Contains(value))
        {
            list.Remove(value);
        }
        else
        {
            list.Add(value);
        }
        currentValue = [.. list];
    }

    private void SelectAll()
    {
        currentValue = [.. AllValues];
    }

    private void ClearAll()
    {
        currentValue = [];
    }

    private void HandleSubmit()
    {
        var data = new System.Text.StringBuilder();
        if (!string.IsNullOrEmpty(Name) && currentValue?.Length > 0)
        {
            data.Append(string.Join("&", currentValue.Select(v => $"{Name}={v}")));
        }
        formData = data.ToString();
    }
}
