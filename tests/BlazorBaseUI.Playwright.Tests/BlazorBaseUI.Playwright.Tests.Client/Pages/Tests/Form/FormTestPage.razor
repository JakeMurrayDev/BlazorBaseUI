@page "/tests/form/wasm"
@using BlazorBaseUI.Field
@using BlazorBaseUI.Form
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))

<PageTitle>Form Test Page (WebAssembly)</PageTitle>

<div data-testid="test-container" data-interactive="@RendererInfo.IsInteractive.ToString().ToLowerInvariant()">
    @switch (Scenario)
    {
        case "submit-with-errors":
            @RenderSubmitWithErrors()
            break;
        case "unmounted-fields":
            @RenderUnmountedFields()
            break;
        case "focus-invalid-on-submit":
            @RenderFocusInvalidOnSubmit()
            break;
        case "errors-removed-on-change":
            @RenderErrorsRemovedOnChange()
            break;
        case "on-form-submit":
            @RenderOnFormSubmit()
            break;
        case "actions-ref-validate":
            @RenderActionsRefValidate()
            break;
        case "actions-ref-validate-field":
            @RenderActionsRefValidateField()
            break;
        default:
            @RenderSubmitWithErrors()
            break;
    }

    <div data-testid="state-display" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;">
        <div>Submit Count: <span data-testid="submit-count">@submitCount</span></div>
        <div>Valid Submit Count: <span data-testid="valid-submit-count">@validSubmitCount</span></div>
        <div>Invalid Submit Count: <span data-testid="invalid-submit-count">@invalidSubmitCount</span></div>
        <div>Form Submit Count: <span data-testid="form-submit-count">@formSubmitCount</span></div>
        <div>Last Submit Values: <span data-testid="last-submit-values">@lastSubmitValues</span></div>
    </div>
</div>

@code {
    private RenderFragment RenderSubmitWithErrors() => @<Form Model="model" ValidationMode="ValidationMode.OnSubmit"
          OnValidSubmit="HandleValidSubmit" OnInvalidSubmit="HandleInvalidSubmit">
        <FieldRoot Name="name" Validate="ValidateRequired" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldError data-testid="field-error" />
        </FieldRoot>
        <button type="submit" data-testid="submit-button">Submit</button>
    </Form>;

    private RenderFragment RenderUnmountedFields() => @<Form Model="model" ValidationMode="ValidationMode.OnSubmit"
          OnValidSubmit="HandleValidSubmit" OnInvalidSubmit="HandleInvalidSubmit">
        <FieldRoot Name="name" Validate="ValidateRequired" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldError data-testid="field-error" />
        </FieldRoot>
        @if (showOptionalField)
        {
            <FieldRoot Name="optional" Validate="ValidateRequired" data-testid="field-root-optional">
                <FieldControl @bind-Value="model.Optional" data-testid="field-control-optional" />
                <FieldError data-testid="field-error-optional" />
            </FieldRoot>
        }
        <button type="submit" data-testid="submit-button">Submit</button>
        <button type="button" data-testid="toggle-field" @onclick="() => showOptionalField = !showOptionalField">Toggle Optional</button>
    </Form>;

    private RenderFragment RenderFocusInvalidOnSubmit() => @<Form Model="model" ValidationMode="ValidationMode.OnSubmit"
          Errors="@formErrors"
          OnValidSubmit="HandleValidSubmit" OnInvalidSubmit="HandleInvalidSubmit">
        <FieldRoot Name="first" Validate="ValidateRequired" data-testid="field-root-first">
            <FieldControl @bind-Value="model.Name" data-testid="field-control-first" />
            <FieldError data-testid="field-error-first" />
        </FieldRoot>
        <FieldRoot Name="second" Validate="ValidateRequired" data-testid="field-root-second">
            <FieldControl @bind-Value="model.Email" data-testid="field-control-second" />
            <FieldError data-testid="field-error-second" />
        </FieldRoot>
        <button type="submit" data-testid="submit-button">Submit</button>
    </Form>;

    private RenderFragment RenderErrorsRemovedOnChange() => @<Form Model="model" ValidationMode="ValidationMode.OnSubmit"
          Errors="@formErrors"
          OnValidSubmit="HandleValidSubmit" OnInvalidSubmit="HandleInvalidSubmit">
        <FieldRoot Name="name" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldError data-testid="field-error" />
        </FieldRoot>
        <button type="submit" data-testid="submit-button">Submit</button>
        <button type="button" data-testid="set-errors" @onclick="SetErrors">Set Errors</button>
    </Form>;

    private RenderFragment RenderOnFormSubmit() => @<Form Model="model" ValidationMode="ValidationMode.OnSubmit"
          OnFormSubmit="HandleFormSubmit">
        <FieldRoot Name="name" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
        </FieldRoot>
        <button type="submit" data-testid="submit-button">Submit</button>
    </Form>;

    private RenderFragment RenderActionsRefValidate() => @<Form Model="model" ActionsRef="@(a => formActions = a)">
        <FieldRoot Name="name" Validate="ValidateRequired" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldError data-testid="field-error" />
        </FieldRoot>
        <FieldRoot Name="email" Validate="ValidateRequired" data-testid="field-root-email">
            <FieldControl @bind-Value="model.Email" data-testid="field-control-email" />
            <FieldError data-testid="field-error-email" />
        </FieldRoot>
        <button type="button" data-testid="validate-button" @onclick="HandleValidateAll">Validate All</button>
    </Form>;

    private RenderFragment RenderActionsRefValidateField() => @<Form Model="model" ActionsRef="@(a => formActions = a)">
        <FieldRoot Name="name" Validate="ValidateRequired" data-testid="field-root">
            <FieldControl @bind-Value="model.Name" data-testid="field-control" />
            <FieldError data-testid="field-error" />
        </FieldRoot>
        <FieldRoot Name="email" Validate="ValidateRequired" data-testid="field-root-email">
            <FieldControl @bind-Value="model.Email" data-testid="field-control-email" />
            <FieldError data-testid="field-error-email" />
        </FieldRoot>
        <button type="button" data-testid="validate-name" @onclick="@(() => HandleValidateField("name"))">Validate Name</button>
        <button type="button" data-testid="validate-email" @onclick="@(() => HandleValidateField("email"))">Validate Email</button>
    </Form>;

    private sealed class TestFormModel
    {
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string Optional { get; set; } = "";
    }

    [SupplyParameterFromQuery(Name = "scenario")]
    public string Scenario { get; set; } = "submit-with-errors";

    private TestFormModel model = new();
    private int submitCount;
    private int validSubmitCount;
    private int invalidSubmitCount;
    private int formSubmitCount;
    private string lastSubmitValues = "";
    private bool showOptionalField = true;
    private Dictionary<string, string[]>? formErrors;
    private FormActions? formActions;

    private Task<string[]?> ValidateRequired(object? value)
    {
        var strValue = value?.ToString() ?? "";
        if (string.IsNullOrWhiteSpace(strValue))
            return Task.FromResult<string[]?>(["This field is required"]);
        return Task.FromResult<string[]?>(null);
    }

    private void HandleValidSubmit(Microsoft.AspNetCore.Components.Forms.EditContext context)
    {
        submitCount++;
        validSubmitCount++;
    }

    private void HandleInvalidSubmit(Microsoft.AspNetCore.Components.Forms.EditContext context)
    {
        submitCount++;
        invalidSubmitCount++;
    }

    private void HandleFormSubmit(FormSubmitEventArgs args)
    {
        formSubmitCount++;
        lastSubmitValues = string.Join(", ", args.Values.Select(kv => $"{kv.Key}={kv.Value}"));
    }

    private void SetErrors()
    {
        formErrors = new Dictionary<string, string[]>
        {
            ["name"] = ["Server error: Invalid name"]
        };
    }

    private async Task HandleValidateAll()
    {
        if (formActions is not null)
            await formActions.ValidateAsync();
    }

    private async Task HandleValidateField(string fieldName)
    {
        if (formActions is not null)
            await formActions.ValidateAsync(fieldName);
    }
}
