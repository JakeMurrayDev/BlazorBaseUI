@page "/tests/numberfield/wasm"
@using BlazorBaseUI.NumberField
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))

<PageTitle>NumberField Test Page (WASM)</PageTitle>

<div data-testid="test-container" data-interactive="@RendererInfo.IsInteractive.ToString().ToLowerInvariant()">
    <button data-testid="before-button" type="button">Before</button>

    @if (ShowForm)
    {
        <form data-testid="test-form" @onsubmit="HandleFormSubmit" @onsubmit:preventDefault>
            @RenderNumberField()
            <button data-testid="submit-button" type="submit">Submit</button>
        </form>
    }
    else
    {
        @RenderNumberField()
    }

    <button data-testid="after-button" type="button">After</button>

    <div data-testid="state-display" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;">
        <div>Current Value: <span data-testid="current-value">@(currentValue?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "null")</span></div>
        <div>Change Count: <span data-testid="change-count">@changeCount</span></div>
        <div>Last Change Reason: <span data-testid="last-reason">@lastChangeReason</span></div>
        <div>Committed Value: <span data-testid="committed-value">@(lastCommittedValue?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "null")</span></div>
    </div>

    @if (formSubmitted)
    {
        <div data-testid="form-data" style="margin-top: 10px; padding: 10px; border: 1px solid #ccc;">
            @formDataDisplay
        </div>
    }

    <div style="margin-top: 10px;">
        <button data-testid="set-value-10" type="button" @onclick="() => SetValueTo(10)">Set Value 10</button>
        <button data-testid="set-value-0" type="button" @onclick="() => SetValueTo(0)">Set Value 0</button>
        <button data-testid="toggle-disabled" type="button" @onclick="ToggleDisabled">Toggle Disabled</button>
        <button data-testid="toggle-readonly" type="button" @onclick="ToggleReadOnly">Toggle ReadOnly</button>
    </div>
</div>

@code {
    [SupplyParameterFromQuery(Name = "defaultValue")]
    public double? DefaultValue { get; set; }

    [SupplyParameterFromQuery(Name = "value")]
    public double? ControlledValue { get; set; }

    [SupplyParameterFromQuery(Name = "min")]
    public double? Min { get; set; }

    [SupplyParameterFromQuery(Name = "max")]
    public double? Max { get; set; }

    [SupplyParameterFromQuery(Name = "step")]
    public double? Step { get; set; }

    [SupplyParameterFromQuery(Name = "disabled")]
    public bool? QueryDisabled { get; set; }

    [SupplyParameterFromQuery(Name = "readOnly")]
    public bool? QueryReadOnly { get; set; }

    [SupplyParameterFromQuery(Name = "required")]
    public bool? QueryRequired { get; set; }

    [SupplyParameterFromQuery(Name = "allowWheelScrub")]
    public bool? AllowWheelScrub { get; set; }

    [SupplyParameterFromQuery(Name = "snapOnStep")]
    public bool? SnapOnStep { get; set; }

    [SupplyParameterFromQuery(Name = "locale")]
    public string? Locale { get; set; }

    [SupplyParameterFromQuery(Name = "name")]
    public string? FieldName { get; set; }

    [SupplyParameterFromQuery(Name = "showForm")]
    public bool? QueryShowForm { get; set; }

    [SupplyParameterFromQuery(Name = "showScrubArea")]
    public bool? QueryShowScrubArea { get; set; }

    private bool IsDisabled { get; set; }
    private bool IsReadOnly { get; set; }
    private bool ShowForm => QueryShowForm ?? false;
    private bool ShowScrubArea => QueryShowScrubArea ?? false;

    private double? currentValue;
    private int changeCount;
    private string lastChangeReason = "";
    private double? lastCommittedValue;
    private bool formSubmitted;
    private string formDataDisplay = "";

    protected override void OnInitialized()
    {
        IsDisabled = QueryDisabled ?? false;
        IsReadOnly = QueryReadOnly ?? false;

        if (ControlledValue.HasValue)
        {
            currentValue = ControlledValue;
        }
        else if (DefaultValue.HasValue)
        {
            currentValue = DefaultValue;
        }
    }

    private RenderFragment RenderNumberField() => __builder =>
    {
        <NumberFieldRoot
            Value="@(ControlledValue.HasValue ? currentValue : null)"
            DefaultValue="@(ControlledValue.HasValue ? null : DefaultValue)"
            Min="@Min"
            Max="@Max"
            Step="@(Step ?? 1)"
            Disabled="@IsDisabled"
            ReadOnly="@IsReadOnly"
            Required="@(QueryRequired ?? false)"
            AllowWheelScrub="@(AllowWheelScrub ?? false)"
            SnapOnStep="@(SnapOnStep ?? false)"
            Locale="@Locale"
            Name="@FieldName"
            OnValueChange="HandleValueChange"
            OnValueCommitted="HandleValueCommitted"
            data-testid="numberfield-root">
            <NumberFieldGroup data-testid="numberfield-group">
                <NumberFieldDecrement data-testid="decrement-button">-</NumberFieldDecrement>
                <NumberFieldInput data-testid="numberfield-input" />
                <NumberFieldIncrement data-testid="increment-button">+</NumberFieldIncrement>
            </NumberFieldGroup>
            @if (ShowScrubArea)
            {
                <NumberFieldScrubArea data-testid="scrub-area">
                    <NumberFieldScrubAreaCursor data-testid="scrub-cursor" />
                </NumberFieldScrubArea>
            }
        </NumberFieldRoot>
    };

    private void HandleValueChange(NumberFieldValueChangeEventArgs args)
    {
        currentValue = args.Value;
        changeCount++;
        lastChangeReason = args.Reason.ToString();
    }

    private void HandleValueCommitted(NumberFieldValueCommittedEventArgs args)
    {
        lastCommittedValue = args.Value;
    }

    private void SetValueTo(double value)
    {
        currentValue = value;
    }

    private void ToggleDisabled()
    {
        IsDisabled = !IsDisabled;
    }

    private void ToggleReadOnly()
    {
        IsReadOnly = !IsReadOnly;
    }

    private void HandleFormSubmit()
    {
        formSubmitted = true;
        formDataDisplay = $"{FieldName ?? "value"}={currentValue?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? ""}";
    }
}
