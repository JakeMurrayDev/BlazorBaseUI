@page "/tests/checkbox/wasm"
@using BlazorBaseUI.Checkbox
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))

<PageTitle>Checkbox Test Page (WASM)</PageTitle>

<style>
    .checkbox-root {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border: 2px solid #666;
        border-radius: 4px;
        background-color: white;
        cursor: pointer;
        position: relative;
    }
    .checkbox-root[data-checked] {
        background-color: #4caf50;
        border-color: #4caf50;
    }
    .checkbox-root[data-indeterminate] {
        background-color: #2196f3;
        border-color: #2196f3;
    }
    .checkbox-root[data-disabled] {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .checkbox-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        color: white;
        font-size: 14px;
        font-weight: bold;
    }
</style>

<div data-testid="test-container" data-interactive="@RendererInfo.IsInteractive.ToString().ToLowerInvariant()">
    @if (ShowForm)
    {
        <form data-testid="test-form" @onsubmit="HandleSubmit" @onsubmit:preventDefault>
            @RenderCheckbox()
            <button type="submit" data-testid="submit-button">Submit</button>
            <div data-testid="form-data">@formData</div>
        </form>
    }
    else if (ShowWrappingLabel)
    {
        <label data-testid="wrapping-label">
            @RenderCheckbox()
            Check this option
        </label>
    }
    else if (ShowLabel)
    {
        <div>
            <label data-testid="linked-label" for="my-checkbox">Check this option</label>
            @RenderCheckboxWithId()
        </div>
    }
    else
    {
        @RenderCheckbox()
    }

    <div data-testid="state-display" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;">
        <div>Checked: <span data-testid="checked-state">@(currentChecked.ToString().ToLowerInvariant())</span></div>
        <div>Change Count: <span data-testid="change-count">@changeCount</span></div>
        <div>Click Count: <span data-testid="click-count">@clickCount</span></div>
        <div>Focus Count: <span data-testid="focus-count">@focusCount</span></div>
        <div>Blur Count: <span data-testid="blur-count">@blurCount</span></div>
    </div>

    <button data-testid="outside-button" style="margin-top: 10px;">Outside Button</button>
    <button data-testid="toggle-external" @onclick="ToggleExternal" style="margin-top: 10px;">Toggle Externally</button>
</div>

@code {
    [SupplyParameterFromQuery(Name = "defaultChecked")]
    public bool DefaultChecked { get; set; }

    [SupplyParameterFromQuery(Name = "checked")]
    public bool? Checked { get; set; }

    [SupplyParameterFromQuery(Name = "disabled")]
    public bool Disabled { get; set; }

    [SupplyParameterFromQuery(Name = "readOnly")]
    public bool ReadOnly { get; set; }

    [SupplyParameterFromQuery(Name = "required")]
    public bool Required { get; set; }

    [SupplyParameterFromQuery(Name = "indeterminate")]
    public bool Indeterminate { get; set; }

    [SupplyParameterFromQuery(Name = "name")]
    public string? Name { get; set; }

    [SupplyParameterFromQuery(Name = "value")]
    public string? Value { get; set; }

    [SupplyParameterFromQuery(Name = "uncheckedValue")]
    public string? UncheckedValue { get; set; }

    [SupplyParameterFromQuery(Name = "showLabel")]
    public bool ShowLabel { get; set; }

    [SupplyParameterFromQuery(Name = "showWrappingLabel")]
    public bool ShowWrappingLabel { get; set; }

    [SupplyParameterFromQuery(Name = "showForm")]
    public bool ShowForm { get; set; }

    private bool currentChecked;
    private int changeCount;
    private int clickCount;
    private int focusCount;
    private int blurCount;
    private string formData = "";

    protected override void OnInitialized()
    {
        currentChecked = Checked ?? DefaultChecked;
    }

    private RenderFragment RenderCheckbox() => __builder =>
    {
        <CheckboxRoot
            @bind-Checked="currentChecked"
            DefaultChecked="@DefaultChecked"
            Disabled="@Disabled"
            ReadOnly="@ReadOnly"
            Required="@Required"
            Indeterminate="@Indeterminate"
            Name="@Name"
            Value="@Value"
            UncheckedValue="@UncheckedValue"
            OnCheckedChange="HandleCheckedChange"
            @onfocus="HandleFocus"
            @onblur="HandleBlur"
            @onclick="HandleClick"
            class="checkbox-root"
            data-testid="checkbox-root">
            <CheckboxIndicator class="checkbox-indicator" data-testid="checkbox-indicator">
                @if (Indeterminate)
                {
                    <text>-</text>
                }
                else
                {
                    <text>&#10003;</text>
                }
            </CheckboxIndicator>
        </CheckboxRoot>
    };

    private RenderFragment RenderCheckboxWithId() => __builder =>
    {
        <CheckboxRoot
            id="my-checkbox"
            @bind-Checked="currentChecked"
            DefaultChecked="@DefaultChecked"
            Disabled="@Disabled"
            ReadOnly="@ReadOnly"
            Required="@Required"
            Indeterminate="@Indeterminate"
            Name="@Name"
            Value="@Value"
            UncheckedValue="@UncheckedValue"
            OnCheckedChange="HandleCheckedChange"
            @onfocus="HandleFocus"
            @onblur="HandleBlur"
            @onclick="HandleClick"
            class="checkbox-root"
            data-testid="checkbox-root">
            <CheckboxIndicator class="checkbox-indicator" data-testid="checkbox-indicator">
                @if (Indeterminate)
                {
                    <text>-</text>
                }
                else
                {
                    <text>&#10003;</text>
                }
            </CheckboxIndicator>
        </CheckboxRoot>
    };

    private void HandleCheckedChange(CheckboxCheckedChangeEventArgs args)
    {
        changeCount++;
    }

    private void HandleClick()
    {
        clickCount++;
    }

    private void HandleFocus()
    {
        focusCount++;
    }

    private void HandleBlur()
    {
        blurCount++;
    }

    private void ToggleExternal()
    {
        currentChecked = !currentChecked;
    }

    private void HandleSubmit()
    {
        // Simulate form data collection
        var data = new System.Text.StringBuilder();
        if (!string.IsNullOrEmpty(Name))
        {
            if (currentChecked)
            {
                data.Append($"{Name}={Value ?? "on"}");
            }
            else if (!string.IsNullOrEmpty(UncheckedValue))
            {
                data.Append($"{Name}={UncheckedValue}");
            }
        }
        formData = data.ToString();
    }
}
