@page "/tests/menu/wasm"
@using BlazorBaseUI.Menu
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))

<PageTitle>Menu Test Page (WASM)</PageTitle>

<div data-testid="test-container" data-interactive="@RendererInfo.IsInteractive.ToString().ToLowerInvariant()" dir="@Direction">
    <MenuRoot
        @bind-Open="isOpen"
        DefaultOpen="@DefaultOpen"
        Disabled="@Disabled"
        Modal="@(Modal ? ModalMode.True : ModalMode.False)"
        Orientation="@((Orientation ?? "vertical") == "horizontal" ? MenuOrientation.Horizontal : MenuOrientation.Vertical)"
        Direction="@(Direction == "rtl" ? TextDirection.Rtl : TextDirection.Ltr)"
        LoopFocus="@LoopFocus"
        HighlightItemOnHover="@HighlightItemOnHover"
        OnOpenChange="HandleOpenChange"
        OnOpenChangeComplete="HandleOpenChangeComplete"
        >
        <MenuTrigger
            OpenOnHover="@OpenOnHover"
            Delay="@OpenDelay"
            CloseDelay="@CloseDelay"
            data-testid="menu-trigger">
            Open Menu
        </MenuTrigger>
        <MenuPortal>
            <MenuPositioner data-testid="menu-positioner">
                <MenuPopup data-testid="menu-popup">
                    <MenuItem data-testid="menu-item-1" @onclick="() => HandleItemClick(1)">
                        Item 1
                    </MenuItem>
                    <MenuItem data-testid="menu-item-2" @onclick="() => HandleItemClick(2)">
                        Item 2
                    </MenuItem>
                    <MenuItem data-testid="menu-item-3" Disabled="true">
                        Item 3 (Disabled)
                    </MenuItem>
                    <MenuItem data-testid="menu-item-4" @onclick="() => HandleItemClick(4)">
                        Item 4
                    </MenuItem>
                    <MenuItem data-testid="menu-item-no-close" CloseOnClick="false" @onclick="() => HandleItemClick(5)">
                        Item 5 (No Close)
                    </MenuItem>

                    @if (ShowTextNavItems)
                    {
                        <MenuItem data-testid="menu-item-apple" Label="Apple" @onclick="() => HandleItemClick(10)">
                            Apple
                        </MenuItem>
                        <MenuItem data-testid="menu-item-banana" Label="Banana" @onclick="() => HandleItemClick(11)">
                            Banana
                        </MenuItem>
                        <MenuItem data-testid="menu-item-cherry" Label="Cherry" @onclick="() => HandleItemClick(12)">
                            Cherry
                        </MenuItem>
                        <MenuItem data-testid="menu-item-apricot" Label="Apricot" @onclick="() => HandleItemClick(13)">
                            Apricot
                        </MenuItem>
                    }

                    @if (ShowCheckbox)
                    {
                        <MenuCheckboxItem
                            @bind-Checked="checkboxChecked"
                            DefaultChecked="@DefaultChecked"
                            OnCheckedChange="HandleCheckboxChange"
                            data-testid="menu-checkbox-item">
                            Checkbox Item
                        </MenuCheckboxItem>
                    }

                    @if (ShowRadioGroup)
                    {
                        <MenuRadioGroup
                            @bind-Value="radioValue"
                            DefaultValue="@DefaultRadioValue"
                            OnValueChange="HandleRadioChange"
                            data-testid="menu-radio-group">
                            <MenuRadioItem Value="@("option1")" data-testid="menu-radio-item-1">
                                Option 1
                            </MenuRadioItem>
                            <MenuRadioItem Value="@("option2")" data-testid="menu-radio-item-2">
                                Option 2
                            </MenuRadioItem>
                            <MenuRadioItem Value="@("option3")" Disabled="true" data-testid="menu-radio-item-3">
                                Option 3 (Disabled)
                            </MenuRadioItem>
                        </MenuRadioGroup>
                    }

                    @if (ShowSubmenu)
                    {
                        <MenuSubmenuRoot
                            @bind-Open="submenuOpen"
                            CloseParentOnEsc="@CloseParentOnEsc"
                            Direction="@(Direction == "rtl" ? TextDirection.Rtl : TextDirection.Ltr)"
                            OnOpenChange="HandleSubmenuOpenChange"
                            >
                            <MenuSubmenuTrigger data-testid="submenu-trigger">
                                Submenu
                            </MenuSubmenuTrigger>
                            <MenuPortal>
                                <MenuPositioner data-testid="submenu-positioner">
                                    <MenuPopup data-testid="submenu-popup">
                                        <MenuItem data-testid="submenu-item-1" @onclick="() => HandleSubmenuItemClick(1)">
                                            Submenu Item 1
                                        </MenuItem>
                                        <MenuItem data-testid="submenu-item-2" @onclick="() => HandleSubmenuItemClick(2)">
                                            Submenu Item 2
                                        </MenuItem>
                                        @if (ShowNestedSubmenu)
                                        {
                                            <MenuSubmenuRoot @bind-Open="nestedSubmenuOpen" Direction="@(Direction == "rtl" ? TextDirection.Rtl : TextDirection.Ltr)" OnOpenChange="HandleNestedSubmenuOpenChange">
                                                <MenuSubmenuTrigger data-testid="nested-submenu-trigger">
                                                    Nested Submenu
                                                </MenuSubmenuTrigger>
                                                <MenuPortal>
                                                    <MenuPositioner data-testid="nested-submenu-positioner">
                                                        <MenuPopup data-testid="nested-submenu-popup">
                                                            <MenuItem data-testid="nested-submenu-item-1" @onclick="() => HandleNestedSubmenuItemClick(1)">
                                                                Nested Item 1
                                                            </MenuItem>
                                                            <MenuItem data-testid="nested-submenu-item-2" @onclick="() => HandleNestedSubmenuItemClick(2)">
                                                                Nested Item 2
                                                            </MenuItem>
                                                        </MenuPopup>
                                                    </MenuPositioner>
                                                </MenuPortal>
                                            </MenuSubmenuRoot>
                                        }
                                    </MenuPopup>
                                </MenuPositioner>
                            </MenuPortal>
                        </MenuSubmenuRoot>
                    }
                </MenuPopup>
            </MenuPositioner>
        </MenuPortal>
    </MenuRoot>

    <div data-testid="state-display" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;">
        <div>Open: <span data-testid="open-state">@isOpen.ToString().ToLowerInvariant()</span></div>
        <div>Change Count: <span data-testid="change-count">@changeCount</span></div>
        <div>Last Reason: <span data-testid="last-reason">@lastReason</span></div>
        <div>Complete Count: <span data-testid="complete-count">@completeCount</span></div>
        <div>Last Item Clicked: <span data-testid="last-item-clicked">@lastItemClicked</span></div>
        @if (ShowCheckbox)
        {
            <div>Checkbox State: <span data-testid="checkbox-state">@checkboxChecked.ToString().ToLowerInvariant()</span></div>
        }
        @if (ShowRadioGroup)
        {
            <div>Radio Value: <span data-testid="radio-state">@radioValue</span></div>
        }
        @if (ShowSubmenu)
        {
            <div>Submenu Open: <span data-testid="submenu-state">@submenuOpen.ToString().ToLowerInvariant()</span></div>
            <div>Submenu Item Clicked: <span data-testid="submenu-item-clicked">@lastSubmenuItemClicked</span></div>
            @if (ShowNestedSubmenu)
            {
                <div>Nested Submenu Open: <span data-testid="nested-submenu-state">@nestedSubmenuOpen.ToString().ToLowerInvariant()</span></div>
                <div>Nested Submenu Item Clicked: <span data-testid="nested-submenu-item-clicked">@lastNestedSubmenuItemClicked</span></div>
            }
        }
    </div>

    <button data-testid="outside-button" style="margin-top: 10px;">Outside Button</button>
</div>

@code {
    [SupplyParameterFromQuery(Name = "defaultOpen")]
    public bool DefaultOpen { get; set; }

    [SupplyParameterFromQuery(Name = "disabled")]
    public bool Disabled { get; set; }

    [SupplyParameterFromQuery(Name = "modal")]
    public bool Modal { get; set; }

    [SupplyParameterFromQuery(Name = "orientation")]
    public string Orientation { get; set; } = "vertical";

    [SupplyParameterFromQuery(Name = "loopFocus")]
    public bool LoopFocus { get; set; } = true;

    [SupplyParameterFromQuery(Name = "openOnHover")]
    public bool OpenOnHover { get; set; }

    [SupplyParameterFromQuery(Name = "openDelay")]
    public int OpenDelay { get; set; }

    [SupplyParameterFromQuery(Name = "closeDelay")]
    public int CloseDelay { get; set; }

    [SupplyParameterFromQuery(Name = "showCheckbox")]
    public bool ShowCheckbox { get; set; }

    [SupplyParameterFromQuery(Name = "showRadioGroup")]
    public bool ShowRadioGroup { get; set; }

    [SupplyParameterFromQuery(Name = "showSubmenu")]
    public bool ShowSubmenu { get; set; }

    [SupplyParameterFromQuery(Name = "closeParentOnEsc")]
    public bool CloseParentOnEsc { get; set; }

    [SupplyParameterFromQuery(Name = "defaultChecked")]
    public bool DefaultChecked { get; set; }

    [SupplyParameterFromQuery(Name = "defaultRadioValue")]
    public string? DefaultRadioValue { get; set; }

    [SupplyParameterFromQuery(Name = "highlightItemOnHover")]
    public bool HighlightItemOnHover { get; set; } = true;

    [SupplyParameterFromQuery(Name = "showTextNavItems")]
    public bool ShowTextNavItems { get; set; }

    [SupplyParameterFromQuery(Name = "showNestedSubmenu")]
    public bool ShowNestedSubmenu { get; set; }

    [SupplyParameterFromQuery(Name = "direction")]
    public string Direction { get; set; } = "ltr";

    private bool isOpen;
    private int changeCount;
    private string lastReason = "";
    private int completeCount;
    private int lastItemClicked;
    private bool checkboxChecked;
    private object? radioValue;
    private bool submenuOpen;
    private int lastSubmenuItemClicked;
    private bool nestedSubmenuOpen;
    private int lastNestedSubmenuItemClicked;

    protected override void OnInitialized()
    {
        isOpen = DefaultOpen;
        checkboxChecked = DefaultChecked;
        radioValue = DefaultRadioValue;
    }

    private void HandleOpenChange(MenuOpenChangeEventArgs args)
    {
        changeCount++;
        lastReason = args.Reason.ToString();
    }

    private void HandleOpenChangeComplete(bool open)
    {
        completeCount++;
    }

    private void HandleItemClick(int itemNumber)
    {
        lastItemClicked = itemNumber;
    }

    private void HandleCheckboxChange(MenuCheckboxItemChangeEventArgs args)
    {
    }

    private void HandleRadioChange(MenuRadioGroupChangeEventArgs args)
    {
    }

    private void HandleSubmenuOpenChange(MenuOpenChangeEventArgs args)
    {
    }

    private void HandleSubmenuItemClick(int itemNumber)
    {
        lastSubmenuItemClicked = itemNumber;
    }

    private void HandleNestedSubmenuOpenChange(MenuOpenChangeEventArgs args)
    {
    }

    private void HandleNestedSubmenuItemClick(int itemNumber)
    {
        lastNestedSubmenuItemClicked = itemNumber;
    }
}
