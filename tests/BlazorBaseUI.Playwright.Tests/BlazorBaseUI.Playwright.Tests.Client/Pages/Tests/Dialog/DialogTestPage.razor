@page "/tests/dialog/wasm"
@using BlazorBaseUI.Dialog
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))

<PageTitle>Dialog Test Page (WebAssembly)</PageTitle>

<div data-testid="test-container" data-interactive="@RendererInfo.IsInteractive.ToString().ToLowerInvariant()">
    <DialogRoot
        @bind-Open="isOpen"
        DefaultOpen="@DefaultOpen"
        Modal="@(Modal ? ModalMode.True : ModalMode.False)"
        ActionsRef="@actionsRef"
        OnOpenChange="HandleOpenChange">
        <DialogTrigger data-testid="dialog-trigger">
            Open Dialog
        </DialogTrigger>
        <DialogPortal KeepMounted="@KeepMounted">
            @if (ShowBackdrop)
            {
                <DialogBackdrop data-testid="dialog-backdrop" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5);" />
            }
            @if (ShowViewport)
            {
                <DialogViewport data-testid="dialog-viewport">
                    @RenderPopup()
                </DialogViewport>
            }
            else
            {
                @RenderPopup()
            }
        </DialogPortal>
    </DialogRoot>

    <div data-testid="state-display" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;">
        <div>Open: <span data-testid="open-state">@isOpen.ToString().ToLowerInvariant()</span></div>
        <div>Change Count: <span data-testid="change-count">@changeCount</span></div>
        <div>Last Reason: <span data-testid="last-reason">@lastReason</span></div>
    </div>

    <button data-testid="outside-button" style="margin-top: 10px;">Outside Button</button>
    <input data-testid="focusable-input" type="text" placeholder="Focusable input" style="margin-top: 10px;" />

    @if (ShowActionsButtons)
    {
        <div style="margin-top: 10px;">
            <button data-testid="actions-open" @onclick="() => actionsRef?.Open?.Invoke()">Actions Open</button>
            <button data-testid="actions-close" @onclick="() => actionsRef?.Close?.Invoke()">Actions Close</button>
        </div>
    }
</div>

@code {
    private RenderFragment RenderPopup() => @<DialogPopup data-testid="dialog-popup" InitialFocus="@(UseInitialFocus ? closeButtonRef : null)">
        @if (ShowTitle)
        {
            <DialogTitle data-testid="dialog-title">Dialog Title</DialogTitle>
        }
        @if (ShowDescription)
        {
            <DialogDescription data-testid="dialog-description">This is a dialog description.</DialogDescription>
        }
        <div data-testid="dialog-content">Dialog Content</div>
        @if (ShowClose)
        {
            <DialogClose @ref="closeButtonComponent" data-testid="dialog-close">Close</DialogClose>
        }
        @if (ShowNestedDialog)
        {
            <DialogRoot
                @bind-Open="nestedIsOpen"
                Modal="ModalMode.False"
                OnOpenChange="HandleNestedOpenChange">
                <DialogTrigger data-testid="nested-dialog-trigger">
                    Open Nested
                </DialogTrigger>
                <DialogPortal>
                    <DialogPopup data-testid="nested-dialog-popup">
                        <DialogTitle data-testid="nested-dialog-title">Nested Dialog</DialogTitle>
                        <div>Nested Content</div>
                        <DialogClose data-testid="nested-dialog-close">Close Nested</DialogClose>
                    </DialogPopup>
                </DialogPortal>
            </DialogRoot>
        }
    </DialogPopup>;

    [SupplyParameterFromQuery(Name = "defaultOpen")]
    public bool DefaultOpen { get; set; }

    [SupplyParameterFromQuery(Name = "modal")]
    public bool? ModalParam { get; set; }

    private bool Modal => ModalParam ?? true;

    [SupplyParameterFromQuery(Name = "keepMounted")]
    public bool KeepMounted { get; set; }

    [SupplyParameterFromQuery(Name = "showClose")]
    public bool? ShowCloseParam { get; set; }

    private bool ShowClose => ShowCloseParam ?? true;

    [SupplyParameterFromQuery(Name = "showTitle")]
    public bool ShowTitle { get; set; }

    [SupplyParameterFromQuery(Name = "showDescription")]
    public bool ShowDescription { get; set; }

    [SupplyParameterFromQuery(Name = "showBackdrop")]
    public bool ShowBackdrop { get; set; }

    [SupplyParameterFromQuery(Name = "showViewport")]
    public bool ShowViewport { get; set; }

    [SupplyParameterFromQuery(Name = "showNestedDialog")]
    public bool ShowNestedDialog { get; set; }

    [SupplyParameterFromQuery(Name = "showActionsButtons")]
    public bool ShowActionsButtons { get; set; }

    [SupplyParameterFromQuery(Name = "useInitialFocus")]
    public bool UseInitialFocus { get; set; }

    private bool isOpen;
    private bool nestedIsOpen;
    private int changeCount;
    private string lastReason = "";
    private DialogRootActions? actionsRef = new();
    private DialogClose? closeButtonComponent;
    private ElementReference? closeButtonRef => closeButtonComponent?.Element;

    protected override void OnInitialized()
    {
        isOpen = DefaultOpen;
    }

    private void HandleOpenChange(DialogOpenChangeEventArgs args)
    {
        changeCount++;
        lastReason = args.Reason.ToString();
    }

    private void HandleNestedOpenChange(DialogOpenChangeEventArgs args)
    {
        // Handle nested dialog state changes
    }
}
