@page "/tests/switch/wasm"
@using BlazorBaseUI.Switch
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))

<PageTitle>Switch Test Page (WASM)</PageTitle>

<style>
    .switch-root {
        display: inline-flex;
        align-items: center;
        width: 44px;
        height: 24px;
        padding: 2px;
        border-radius: 12px;
        background-color: #ccc;
        cursor: pointer;
        position: relative;
    }
    .switch-root[data-checked] {
        background-color: #4caf50;
    }
    .switch-root[data-disabled] {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .switch-thumb {
        display: block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: white;
        transition: transform 0.2s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    .switch-root[data-checked] .switch-thumb {
        transform: translateX(20px);
    }
</style>

<div data-testid="test-container" data-interactive="@RendererInfo.IsInteractive.ToString().ToLowerInvariant()">
    @if (ShowForm)
    {
        <form data-testid="test-form" @onsubmit="HandleSubmit" @onsubmit:preventDefault>
            @RenderSwitch()
            <button type="submit" data-testid="submit-button">Submit</button>
            <div data-testid="form-data">@formData</div>
        </form>
    }
    else if (ShowWrappingLabel)
    {
        <label data-testid="wrapping-label">
            @RenderSwitch()
            Toggle setting
        </label>
    }
    else if (ShowLabel)
    {
        <div>
            <label data-testid="linked-label" for="my-switch">Toggle setting</label>
            @RenderSwitchWithId()
        </div>
    }
    else
    {
        @RenderSwitch()
    }

    <div data-testid="state-display" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;">
        <div>Checked: <span data-testid="checked-state">@(currentChecked.ToString().ToLowerInvariant())</span></div>
        <div>Change Count: <span data-testid="change-count">@changeCount</span></div>
        <div>Click Count: <span data-testid="click-count">@clickCount</span></div>
        <div>Focus Count: <span data-testid="focus-count">@focusCount</span></div>
        <div>Blur Count: <span data-testid="blur-count">@blurCount</span></div>
    </div>

    <button data-testid="outside-button" style="margin-top: 10px;">Outside Button</button>
    <button data-testid="toggle-external" @onclick="ToggleExternal" style="margin-top: 10px;">Toggle Externally</button>
</div>

@code {
    [SupplyParameterFromQuery(Name = "defaultChecked")]
    public bool DefaultChecked { get; set; }

    [SupplyParameterFromQuery(Name = "checked")]
    public bool? Checked { get; set; }

    [SupplyParameterFromQuery(Name = "disabled")]
    public bool Disabled { get; set; }

    [SupplyParameterFromQuery(Name = "readOnly")]
    public bool ReadOnly { get; set; }

    [SupplyParameterFromQuery(Name = "required")]
    public bool Required { get; set; }

    [SupplyParameterFromQuery(Name = "nativeButton")]
    public bool NativeButton { get; set; }

    [SupplyParameterFromQuery(Name = "name")]
    public string? Name { get; set; }

    [SupplyParameterFromQuery(Name = "value")]
    public string? Value { get; set; }

    [SupplyParameterFromQuery(Name = "uncheckedValue")]
    public string? UncheckedValue { get; set; }

    [SupplyParameterFromQuery(Name = "showLabel")]
    public bool ShowLabel { get; set; }

    [SupplyParameterFromQuery(Name = "showWrappingLabel")]
    public bool ShowWrappingLabel { get; set; }

    [SupplyParameterFromQuery(Name = "showForm")]
    public bool ShowForm { get; set; }

    private bool currentChecked;
    private int changeCount;
    private int clickCount;
    private int focusCount;
    private int blurCount;
    private string formData = "";

    protected override void OnInitialized()
    {
        currentChecked = Checked ?? DefaultChecked;
    }

    private RenderFragment RenderSwitch() => __builder =>
    {
        <SwitchRoot
            @bind-Checked="currentChecked"
            DefaultChecked="@DefaultChecked"
            Disabled="@Disabled"
            ReadOnly="@ReadOnly"
            Required="@Required"
            NativeButton="@NativeButton"
            Name="@Name"
            Value="@Value"
            UncheckedValue="@UncheckedValue"
            OnCheckedChange="HandleCheckedChange"
            @onfocus="HandleFocus"
            @onblur="HandleBlur"
            @onclick="HandleClick"
            class="switch-root"
            data-testid="switch-root">
            <SwitchThumb class="switch-thumb" data-testid="switch-thumb" />
        </SwitchRoot>
    };

    private RenderFragment RenderSwitchWithId() => __builder =>
    {
        <SwitchRoot
            id="my-switch"
            @bind-Checked="currentChecked"
            DefaultChecked="@DefaultChecked"
            Disabled="@Disabled"
            ReadOnly="@ReadOnly"
            Required="@Required"
            NativeButton="@NativeButton"
            Name="@Name"
            Value="@Value"
            UncheckedValue="@UncheckedValue"
            OnCheckedChange="HandleCheckedChange"
            @onfocus="HandleFocus"
            @onblur="HandleBlur"
            @onclick="HandleClick"
            class="switch-root"
            data-testid="switch-root">
            <SwitchThumb class="switch-thumb" data-testid="switch-thumb" />
        </SwitchRoot>
    };

    private void HandleCheckedChange(SwitchCheckedChangeEventArgs args)
    {
        changeCount++;
    }

    private void HandleClick()
    {
        clickCount++;
    }

    private void HandleFocus()
    {
        focusCount++;
    }

    private void HandleBlur()
    {
        blurCount++;
    }

    private void ToggleExternal()
    {
        currentChecked = !currentChecked;
    }

    private void HandleSubmit()
    {
        // Simulate form data collection
        var data = new System.Text.StringBuilder();
        if (!string.IsNullOrEmpty(Name))
        {
            if (currentChecked)
            {
                data.Append($"{Name}={Value ?? "on"}");
            }
            else if (!string.IsNullOrEmpty(UncheckedValue))
            {
                data.Append($"{Name}={UncheckedValue}");
            }
        }
        formData = data.ToString();
    }
}
