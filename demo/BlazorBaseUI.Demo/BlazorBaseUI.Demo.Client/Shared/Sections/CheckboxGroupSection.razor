@using BlazorBaseUI.Checkbox
@using BlazorBaseUI.CheckboxGroup
@using BlazorBaseUI.Demo.Client.Shared.Icons
@using BlazorBaseUI.Field
@using BlazorBaseUI.Form

<ComponentShowcase ComponentName="CheckboxGroup"
                   Description="A container that groups multiple checkboxes and manages their collective state."
                   BaseRoute="/checkbox-group"
                   IsWasmMode="IsWasmMode">
    <DemoSection Title="Basic Group"
                 Description="Click to toggle. Uses uncontrolled state with DefaultValue.">
        <CheckboxGroup DefaultValue="@(["red"])"
                       ClassValue="@(_ => "space-y-3")">
            <div class="flex items-center gap-3">
                <CheckboxRoot Value="red" ClassValue="@(state => CheckboxRootClass(state))">
                    <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                        <CheckIcon />
                    </CheckboxIndicator>
                </CheckboxRoot>
                <span class="text-gray-700">Red</span>
            </div>
            <div class="flex items-center gap-3">
                <CheckboxRoot Value="green" ClassValue="@(state => CheckboxRootClass(state))">
                    <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                        <CheckIcon />
                    </CheckboxIndicator>
                </CheckboxRoot>
                <span class="text-gray-700">Green</span>
            </div>
        </CheckboxGroup>
    </DemoSection>

    <DemoSection Title="Controlled Group"
                 Description="State controlled externally via Value/ValueChanged.">
        <div class="flex items-center gap-4">
            <CheckboxGroup Value="@controlledGroupValue"
                           ValueChanged="@(v => controlledGroupValue = v)"
                           ClassValue="@(_ => "space-y-3")">
                <div class="flex items-center gap-3">
                    <CheckboxRoot Value="red" ClassValue="@(state => CheckboxRootClass(state))">
                        <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                            <CheckIcon />
                        </CheckboxIndicator>
                    </CheckboxRoot>
                    <span class="text-gray-700">Red</span>
                </div>
                <div class="flex items-center gap-3">
                    <CheckboxRoot Value="green" ClassValue="@(state => CheckboxRootClass(state))">
                        <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                            <CheckIcon />
                        </CheckboxIndicator>
                    </CheckboxRoot>
                    <span class="text-gray-700">Green</span>
                </div>
            </CheckboxGroup>
        </div>
        <div class="mt-4 text-sm text-gray-600">Selected: @string.Join(", ", controlledGroupValue ?? [])</div>
    </DemoSection>

    <DemoSection Title="Disabled Group"
                 Description="All checkboxes disabled via group. Takes precedence over individual disabled props.">
        <CheckboxGroup Disabled="true"
                       DefaultValue="@(["opt1"])"
                       ClassValue="@(_ => "space-y-3")">
            <div class="flex items-center gap-3">
                <CheckboxRoot Value="opt1" ClassValue="@(state => CheckboxRootClass(state))">
                    <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                        <CheckIcon />
                    </CheckboxIndicator>
                </CheckboxRoot>
                <span class="text-gray-500">Option 1 (checked)</span>
            </div>
            <div class="flex items-center gap-3">
                <CheckboxRoot Value="opt2" Disabled="false" ClassValue="@(state => CheckboxRootClass(state))">
                    <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                        <CheckIcon />
                    </CheckboxIndicator>
                </CheckboxRoot>
                <span class="text-gray-500">Option 2 (disabled=false ignored)</span>
            </div>
        </CheckboxGroup>
    </DemoSection>

    <DemoSection Title="Parent Checkbox (Select All)"
                 Description="Parent checkbox controls all children. Shows indeterminate when partially selected.">
        <CheckboxGroup Value="@parentGroupValue"
                       ValueChanged="@(v => parentGroupValue = v)"
                       AllValues="@allColors"
                       ClassValue="@(_ => "space-y-3")">
            <div class="flex items-center gap-3 border-b border-gray-200 pb-3">
                <CheckboxRoot Parent="true" ClassValue="@(state => CheckboxRootClass(state))">
                    <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                        @if (IsIndeterminate(parentGroupValue, allColors))
                        {
                            <MinusIcon />
                        }
                        else
                        {
                            <CheckIcon />
                        }
                    </CheckboxIndicator>
                </CheckboxRoot>
                <span class="font-medium text-gray-800">Select All Colors</span>
            </div>
            <div class="space-y-3 pl-6">
                <div class="flex items-center gap-3">
                    <CheckboxRoot Value="red" ClassValue="@(state => CheckboxRootClass(state))">
                        <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                            <CheckIcon />
                        </CheckboxIndicator>
                    </CheckboxRoot>
                    <span class="text-gray-700">Red</span>
                </div>
                <div class="flex items-center gap-3">
                    <CheckboxRoot Value="green" ClassValue="@(state => CheckboxRootClass(state))">
                        <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                            <CheckIcon />
                        </CheckboxIndicator>
                    </CheckboxRoot>
                    <span class="text-gray-700">Green</span>
                </div>
            </div>
        </CheckboxGroup>

        <div class="mt-4 rounded bg-gray-100 p-3 text-sm">
            <strong>Selected:</strong> @string.Join(", ", parentGroupValue ?? [])
        </div>
    </DemoSection>

    <DemoSection Title="OnValueChange Callback"
                 Description="Callback fires when any checkbox in the group changes.">
        <CheckboxGroup OnValueChange="@HandleValueChange"
                       ClassValue="@(_ => "space-y-3")">
            <div class="flex items-center gap-3">
                <CheckboxRoot Value="one" ClassValue="@(state => CheckboxRootClass(state))">
                    <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                        <CheckIcon />
                    </CheckboxIndicator>
                </CheckboxRoot>
                <span class="text-gray-700">Option 1</span>
            </div>
            <div class="flex items-center gap-3">
                <CheckboxRoot Value="two" ClassValue="@(state => CheckboxRootClass(state))">
                    <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                        <CheckIcon />
                    </CheckboxIndicator>
                </CheckboxRoot>
                <span class="text-gray-700">Option 2</span>
            </div>
        </CheckboxGroup>

        <div class="mt-4 text-sm text-gray-600">Change count: @groupChangeCount</div>
    </DemoSection>

    <DemoSection Title="Field Integration"
                 Description="Field.Item provides LabelableContext for proper label association.">
        <FieldRoot Name="fruits">
            <FieldLabel ClassValue="@(_ => "block text-gray-800 font-medium mb-2")">
                Select your favorite fruits
            </FieldLabel>
            <CheckboxGroup DefaultValue="@(["apple"])"
                           ClassValue="@(_ => "space-y-3")">
                <FieldItem ClassValue="@(_ => "flex items-center gap-3")">
                    <CheckboxRoot Value="apple" ClassValue="@(state => CheckboxRootClass(state))">
                        <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                            <CheckIcon />
                        </CheckboxIndicator>
                    </CheckboxRoot>
                    <FieldLabel ClassValue="@(_ => "text-gray-700 cursor-pointer")">Apple</FieldLabel>
                </FieldItem>
                <FieldItem ClassValue="@(_ => "flex items-center gap-3")">
                    <CheckboxRoot Value="banana" ClassValue="@(state => CheckboxRootClass(state))">
                        <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                            <CheckIcon />
                        </CheckboxIndicator>
                    </CheckboxRoot>
                    <FieldLabel ClassValue="@(_ => "text-gray-700 cursor-pointer")">Banana</FieldLabel>
                </FieldItem>
            </CheckboxGroup>
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="Field State Tracking"
                 Description="Tracks touched, dirty, filled, focused states for the group.">
        <FieldRoot Name="tracking">
            <CheckboxGroup DefaultValue="@(["A"])" ClassValue="@(_ => "space-y-3")">
                <FieldItem ClassValue="@(_ => "flex items-center gap-3")">
                    <CheckboxRoot Value="A" ClassValue="@(state => CheckboxRootClass(state))">
                        <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                            <CheckIcon />
                        </CheckboxIndicator>
                    </CheckboxRoot>
                    <FieldLabel ClassValue="@(_ => "text-gray-700 cursor-pointer")">Option A</FieldLabel>
                </FieldItem>
                <FieldItem ClassValue="@(_ => "flex items-center gap-3")">
                    <CheckboxRoot Value="B" ClassValue="@(state => CheckboxRootClass(state))">
                        <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                            <CheckIcon />
                        </CheckboxIndicator>
                    </CheckboxRoot>
                    <FieldLabel ClassValue="@(_ => "text-gray-700 cursor-pointer")">Option B</FieldLabel>
                </FieldItem>
            </CheckboxGroup>
            <FieldStateDisplay Context="fieldState">
                <div class="mt-3 space-y-1 text-xs">
                    <div class="flex gap-4">
                        <StateIndicator Label="Touched" IsActive="@fieldState.Touched" />
                        <StateIndicator Label="Dirty" IsActive="@fieldState.Dirty" />
                        <StateIndicator Label="Filled" IsActive="@fieldState.Filled" />
                    </div>
                </div>
            </FieldStateDisplay>
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="Validation"
                 Description="Supports required validation and custom validate function.">
        <FieldRoot Name="features"
                   ValidationMode="ValidationMode.OnChange"
                   Validate="@ValidateNoExperimental">
            <CheckboxGroup ClassValue="@(_ => "space-y-3")">
                <FieldItem ClassValue="@(_ => "flex items-center gap-3")">
                    <CheckboxRoot Value="stable" ClassValue="@(state => CheckboxRootClass(state))">
                        <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                            <CheckIcon />
                        </CheckboxIndicator>
                    </CheckboxRoot>
                    <FieldLabel ClassValue="@(_ => "text-gray-700 cursor-pointer")">Stable Feature</FieldLabel>
                </FieldItem>
                <FieldItem ClassValue="@(_ => "flex items-center gap-3")">
                    <CheckboxRoot Value="experimental" ClassValue="@(state => CheckboxRootClass(state))">
                        <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                            <CheckIcon />
                        </CheckboxIndicator>
                    </CheckboxRoot>
                    <FieldLabel ClassValue="@(_ => "text-gray-700 cursor-pointer")">Experimental Feature</FieldLabel>
                </FieldItem>
            </CheckboxGroup>
            <FieldError ClassValue="@(_ => "text-red-600 text-sm mt-2")" />
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="External Errors"
                 Description="Errors can be set externally via Form. Cleared on change.">
        <Form Model="@(new object())" Errors="@externalGroupErrors">
            <FieldRoot Name="group">
                <CheckboxGroup DefaultValue="@(["one"])"
                               ClassValue="@(_ => "space-y-3")">
                    <FieldItem ClassValue="@(_ => "flex items-center gap-3")">
                        <CheckboxRoot Value="one" ClassValue="@(state => CheckboxRootClass(state))">
                            <CheckboxIndicator ClassValue="@(state => CheckboxIndicatorClass(state))">
                                <CheckIcon />
                            </CheckboxIndicator>
                        </CheckboxRoot>
                        <FieldLabel ClassValue="@(_ => "text-gray-700 cursor-pointer")">One</FieldLabel>
                    </FieldItem>
                </CheckboxGroup>
                <FieldError ClassValue="@(_ => "text-red-600 text-sm mt-2")" />
            </FieldRoot>
        </Form>

        <button type="button"
                class="mt-3 rounded bg-red-600 px-3 py-1 text-sm text-white transition hover:bg-red-700"
                @onclick="@SetExternalGroupError">
            Set External Error
        </button>
    </DemoSection>
</ComponentShowcase>

@code {
    [Parameter]
    public bool IsWasmMode { get; set; }

    private string[]? controlledGroupValue = ["red"];
    private string[]? parentGroupValue = ["red"];
    private int groupChangeCount;
    private Dictionary<string, string[]> externalGroupErrors = new();

    private static readonly string[] allColors = ["red", "green"];

    private void HandleValueChange(CheckboxGroupValueChangeEventArgs args)
    {
        groupChangeCount++;
    }

    private Task<string[]?> ValidateNoExperimental(object? value)
    {
        if (value is string[] arr && arr.Contains("experimental"))
            return Task.FromResult<string[]?>(["Experimental features are not allowed"]);
        return Task.FromResult<string[]?>(null);
    }

    private void SetExternalGroupError()
    {
        externalGroupErrors = new Dictionary<string, string[]>
        {
            ["group"] = ["This is an external server error"]
        };
    }

    private static bool IsIndeterminate(string[]? value, string[] allValues)
    {
        var count = value?.Length ?? 0;
        return count > 0 && count < allValues.Length;
    }

    private static string CheckboxRootClass(CheckboxRootState state)
    {
        var baseClass = "relative inline-flex h-5 w-5 items-center justify-center rounded border-2 transition-all outline-none";
        if (state.Disabled) return $"{baseClass} border-gray-200 bg-gray-50 opacity-50";
        if (state.Valid == false) return $"{baseClass} border-red-500 bg-red-50";
        if (state.Checked || state.Indeterminate) return $"{baseClass} border-indigo-600 bg-indigo-600";
        return $"{baseClass} border-gray-300 bg-white hover:border-gray-400";
    }

    private static string CheckboxIndicatorClass(CheckboxIndicatorState state)
    {
        return "flex items-center justify-center text-white";
    }
}