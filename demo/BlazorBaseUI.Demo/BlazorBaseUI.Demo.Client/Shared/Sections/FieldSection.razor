@using BlazorBaseUI.Field
@using BlazorBaseUI.Form
<ComponentShowcase ComponentName="Field"
                   Description="A component that provides labeling and validation for form controls."
                   BaseRoute="/field"
                   IsWasmMode="IsWasmMode">
    <DemoSection Title="Disabled State"
                 Description="Should add data-disabled to all components">
        <FieldRoot Disabled="true"
                   ClassValue="@(s => "p-4 border rounded " + (s.Disabled ? "bg-gray-100" : ""))">
            <FieldLabel ClassValue="@(s => "block text-sm font-medium " + (s.Disabled ? "text-gray-400" : "text-gray-700"))">
                Disabled Label
            </FieldLabel>
            <FieldControl TValue="string" DefaultValue=@("Test") ClassValue="@(s => "mt-1 block w-full rounded border p-2 " + (s.Disabled ? "bg-gray-200 cursor-not-allowed" : ""))"
                          placeholder="Disabled input" />
            <FieldDescription ClassValue="@(s => "text-sm " + (s.Disabled ? "text-gray-400" : "text-gray-500"))">
                This field is disabled
            </FieldDescription>
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="Touched State"
                 Description="Focus and blur to see data-touched applied">
        <FieldRoot ClassValue="@(s => "p-4 border rounded " + (s.Touched ? "border-blue-500" : "border-gray-300"))">
            <FieldLabel ClassValue="@(s => "block text-sm font-medium " + (s.Touched ? "text-blue-600" : "text-gray-700"))">
                Touch me (focus then blur)
            </FieldLabel>
            <FieldControl TValue="string" DefaultValue=@("Test") ClassValue="@(s => "mt-1 block w-full rounded border p-2 " + (s.Touched ? "border-blue-500" : "border-gray-300"))" />
            <FieldDescription ClassValue="@(s => "text-sm " + (s.Touched ? "text-blue-500" : "text-gray-500"))">
                Focus then blur to touch
            </FieldDescription>
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="Dirty State"
                 Description="Type something to see data-dirty applied, clear to remove">
        <FieldRoot ClassValue="@(s => "p-4 border rounded " + (s.Dirty ? "border-yellow-500" : "border-gray-300"))">
            <FieldLabel ClassValue="@(s => "block text-sm font-medium " + (s.Dirty ? "text-yellow-600" : "text-gray-700"))">
                Make me dirty
            </FieldLabel>
            <FieldControl TValue="string" DefaultValue=@("Test") ClassValue="@(s => "mt-1 block w-full rounded border p-2 " + (s.Dirty ? "border-yellow-500 bg-yellow-50" : "border-gray-300"))" />
            <FieldDescription ClassValue="@(s => "text-sm " + (s.Dirty ? "text-yellow-600" : "text-gray-500"))">
                Type to make dirty, clear to clean
            </FieldDescription>
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="Filled State"
                 Description="Type something to see data-filled applied">
        <FieldRoot ClassValue="@(s => "p-4 border rounded " + (s.Filled ? "border-green-500" : "border-gray-300"))">
            <FieldLabel ClassValue="@(s => "block text-sm font-medium " + (s.Filled ? "text-green-600" : "text-gray-700"))">
                Fill me
            </FieldLabel>
            <FieldControl TValue="string" DefaultValue=@("Test") ClassValue="@(s => "mt-1 block w-full rounded border p-2 " + (s.Filled ? "border-green-500 bg-green-50" : "border-gray-300"))" />
            <FieldDescription ClassValue="@(s => "text-sm " + (s.Filled ? "text-green-600" : "text-gray-500"))">
                Type to fill, clear to empty
            </FieldDescription>
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="Focused State"
                 Description="Click to focus and see data-focused applied">
        <FieldRoot ClassValue="@(s => "p-4 border rounded " + (s.Focused ? "border-purple-500 ring-2 ring-purple-200" : "border-gray-300"))">
            <FieldLabel ClassValue="@(s => "block text-sm font-medium " + (s.Focused ? "text-purple-600" : "text-gray-700"))">
                Focus me
            </FieldLabel>
            <FieldControl TValue="string" DefaultValue=@("Test") ClassValue="@(s => "mt-1 block w-full rounded border p-2 " + (s.Focused ? "border-purple-500 outline-none" : "border-gray-300"))" />
            <FieldDescription ClassValue="@(s => "text-sm " + (s.Focused ? "text-purple-600" : "text-gray-500"))">
                Click input to focus
            </FieldDescription>
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="Controlled Dirty/Touched Props"
                 Description="External control of dirty and touched state">
        <div class="mb-2 flex gap-4">
            <label class="flex items-center gap-2">
                <input type="checkbox" @bind="controlledDirty" class="rounded" />
                <span class="text-sm">Dirty</span>
            </label>
            <label class="flex items-center gap-2">
                <input type="checkbox" @bind="controlledTouched" class="rounded" />
                <span class="text-sm">Touched</span>
            </label>
        </div>
        <FieldRoot DirtyState="@controlledDirty"
                   TouchedState="@controlledTouched"
                   ClassValue="@(s => "p-4 border rounded " + GetStateClasses(s))">
            <FieldLabel ClassValue="@(s => "block text-sm font-medium text-gray-700")">
                Controlled Field
            </FieldLabel>
            <FieldControl TValue="string" DefaultValue=@("Test") ClassValue="@(s => "mt-1 block w-full rounded border p-2 border-gray-300")" />
            <FieldDescription ClassValue="@(s => "text-sm text-gray-500")">
                Dirty: @controlledDirty, Touched: @controlledTouched
            </FieldDescription>
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="Label Association"
                 Description="Label should have for attribute matching control id">
        <FieldRoot ClassValue="@(_ => "p-4 border rounded border-gray-300")">
            <FieldLabel ClassValue="@(_ => "block text-sm font-medium text-gray-700 cursor-pointer")">
                Click this label to focus the input
            </FieldLabel>
            <FieldControl TValue="string" DefaultValue=@("Test") ClassValue="@(_ => "mt-1 block w-full rounded border p-2 border-gray-300")" />
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="Aria Describedby"
                 Description="Control should have aria-describedby referencing description and error">
        <FieldRoot Invalid="true" ClassValue="@(_ => "p-4 border rounded border-red-300")">
            <FieldLabel ClassValue="@(_ => "block text-sm font-medium text-gray-700")">
                Field with Description and Error
            </FieldLabel>
            <FieldControl TValue="string" DefaultValue=@("Test") ClassValue="@(_ => "mt-1 block w-full rounded border p-2 border-red-300")" />
            <FieldDescription ClassValue="@(_ => "text-sm text-gray-500")">
                This is a helpful description
            </FieldDescription>
            <FieldError Match="true" ClassValue="@(_ => "text-sm text-red-600")">
                This is an error message
            </FieldError>
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="Validation Mode: OnBlur"
                 Description="Type less than 3 characters and blur to see validation">
        <FieldRoot ValidationMode="ValidationMode.OnBlur"
                   Validate="ValidateMinLength"
                   ClassValue="@(s => "p-4 border rounded " + (s.Valid == false ? "border-red-500" : "border-gray-300"))">
            <FieldLabel ClassValue="@(s => "block text-sm font-medium " + (s.Valid == false ? "text-red-600" : "text-gray-700"))">
                Minimum 3 characters
            </FieldLabel>
            <FieldControl TValue="string" DefaultValue=@("Test") ClassValue="@(s => "mt-1 block w-full rounded border p-2 " + (s.Valid == false ? "border-red-500" : "border-gray-300"))" />
            <FieldError ClassValue="@(_ => "text-sm text-red-600 mt-1")" />
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="Validation Mode: OnChange"
                 Description="Validation runs on every keystroke">
        <FieldRoot ValidationMode="ValidationMode.OnChange"
                   Validate="ValidateMinLength"
                   ClassValue="@(s => "p-4 border rounded " + (s.Valid == false ? "border-red-500" : s.Valid == true ? "border-green-500" : "border-gray-300"))">
            <FieldLabel ClassValue="@(s => "block text-sm font-medium " + (s.Valid == false ? "text-red-600" : s.Valid == true ? "text-green-600" : "text-gray-700"))">
                Minimum 3 characters (live validation)
            </FieldLabel>
            <FieldControl TValue="string" DefaultValue=@("Test") ClassValue="@(s => "mt-1 block w-full rounded border p-2 " + (s.Valid == false ? "border-red-500" : s.Valid == true ? "border-green-500" : "border-gray-300"))" />
            <FieldError ClassValue="@(_ => "text-sm text-red-600 mt-1")" />
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="Debounced Validation (500ms)"
                 Description="Type quickly - validation is debounced">
        <FieldRoot ValidationMode="ValidationMode.OnChange"
                   ValidationDebounceTime="500"
                   Validate="ValidateMinLength"
                   ClassValue="@(s => "p-4 border rounded " + (s.Valid == false ? "border-red-500" : s.Valid == true ? "border-green-500" : "border-gray-300"))">
            <FieldLabel ClassValue="@(_ => "block text-sm font-medium text-gray-700")">
                Debounced (500ms) - Minimum 3 characters
            </FieldLabel>
            <FieldControl TValue="string" DefaultValue=@("Test") ClassValue="@(s => "mt-1 block w-full rounded border p-2 " + (s.Valid == false ? "border-red-500" : s.Valid == true ? "border-green-500" : "border-gray-300"))" />
            <FieldError ClassValue="@(_ => "text-sm text-red-600 mt-1")" />
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="FieldValidity Render Prop"
                 Description="Access validity data directly">
        <FieldRoot ValidationMode="ValidationMode.OnChange"
                   Validate="ValidateEmail"
                   ClassValue="@(_ => "p-4 border rounded border-gray-300")">
            <FieldLabel ClassValue="@(_ => "block text-sm font-medium text-gray-700")">
                Email Address
            </FieldLabel>
            <FieldControl TValue="string" DefaultValue=@("Test")
                          type="email"
                          placeholder="test@example.com"
                          ClassValue="@(_ => "mt-1 block w-full rounded border p-2 border-gray-300")" />
            <div class="mt-2 rounded bg-gray-100 p-2 font-mono text-xs">
                <FieldValidity>
                    <div>Valid: @(context.State.Valid?.ToString() ?? "null")</div>
                    <div>Error: @(string.IsNullOrEmpty(context.Error) ? "(none)" : context.Error)</div>
                    <div>Errors: [@string.Join(", ", context.Errors)]</div>
                </FieldValidity>
            </div>
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="Multiple Errors"
                 Description="Validation returns multiple error messages">
        <FieldRoot ValidationMode="ValidationMode.OnChange"
                   Validate="ValidateMultiple"
                   ClassValue="@(s => "p-4 border rounded " + (s.Valid == false ? "border-red-500" : "border-gray-300"))">
            <FieldLabel ClassValue="@(_ => "block text-sm font-medium text-gray-700")">
                Password (min 8 chars, uppercase, number)
            </FieldLabel>
            <FieldControl TValue="string"
                          DefaultValue=@("Test")
                          ClassValue="@(_ => "mt-1 block w-full rounded border p-2 border-gray-300")"
                          type="password" />
            <FieldError ClassValue="@(_ => "text-sm text-red-600 mt-1")" />
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="ActionsRef (Imperative Validation)"
                 Description="Validate field programmatically via ActionsRef">
        <FieldRoot Name="username"
                   Validate="ValidateRequired"
                   ActionsRef="@(actions => fieldActions = actions)"
                   ClassValue="@(s => "p-4 border rounded " + (s.Valid == false ? "border-red-500" : "border-gray-300"))">
            <FieldLabel ClassValue="@(_ => "block text-sm font-medium text-gray-700")">
                Username (required)
            </FieldLabel>
            <FieldControl TValue="string"
                          ClassValue="@(s => "mt-1 block w-full rounded border p-2 " + (s.Valid == false ? "border-red-500" : "border-gray-300"))"
                          placeholder="Leave empty and click validate" />
            <FieldError ClassValue="@(_ => "text-sm text-red-600 mt-1")" />
        </FieldRoot>
        <button type="button"
                @onclick="ValidateFieldImperatively"
                class="mt-2 rounded bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700">
            Validate Field
        </button>
    </DemoSection>

    <DemoSection Title="NativeLabel (Click to Focus)"
                 Description="Non-label element with NativeLabel=false focuses control on click">
        <FieldRoot ClassValue="@(_ => "p-4 border rounded border-gray-300")">
            <FieldLabel Render="RenderLabelAsSpan"
                        NativeLabel="@false"
                        ClassValue="@(_ => "block text-sm font-medium text-gray-700 cursor-pointer hover:text-blue-600")">
                Click this span to focus the input (NativeLabel=false)
            </FieldLabel>
            <FieldControl TValue="string"
                          ClassValue="@(_ => "mt-1 block w-full rounded border p-2 border-gray-300")"
                          placeholder="Focus me via the span above" />
            <FieldDescription ClassValue="@(_ => "text-sm text-gray-500 mt-1")">
                The label is rendered as a span but clicking it focuses the control
            </FieldDescription>
        </FieldRoot>
    </DemoSection>

    <DemoSection Title="ValueMissing Suppression (Pristine Fields)"
                 Description="Required fields don't show valueMissing error until dirty">
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
            <div class="rounded border p-4">
                <h4 class="mb-2 font-medium">Pristine: Focus, then blur (no error)</h4>
                <FieldRoot ValidationMode="ValidationMode.OnBlur"
                           ClassValue="@(s => "p-3 border rounded " + (s.Valid == false ? "border-red-500" : "border-gray-300"))">
                    <FieldLabel ClassValue="@(_ => "block text-sm font-medium text-gray-700")">
                        Required Field
                    </FieldLabel>
                    <FieldControl TValue="string"
                                  required="true"
                                  ClassValue="@(s => "mt-1 block w-full rounded border p-2 " + (s.Valid == false ? "border-red-500" : "border-gray-300"))"
                                  placeholder="Focus then blur without typing" />
                    <FieldError ClassValue="@(_ => "text-sm text-red-600 mt-1")" />
                    <FieldDescription ClassValue="@(_ => "text-xs text-gray-500 mt-1")">
                        No error shown because field was not "dirtied"
                    </FieldDescription>
                </FieldRoot>
            </div>
            <div class="rounded border p-4">
                <h4 class="mb-2 font-medium">Dirty: Type, clear, then blur (shows error)</h4>
                <FieldRoot ValidationMode="ValidationMode.OnBlur"
                           ClassValue="@(s => "p-3 border rounded " + (s.Valid == false ? "border-red-500" : "border-gray-300"))">
                    <FieldLabel ClassValue="@(_ => "block text-sm font-medium text-gray-700")">
                        Required Field
                    </FieldLabel>
                    <FieldControl TValue="string"
                                  required="true"
                                  ClassValue="@(s => "mt-1 block w-full rounded border p-2 " + (s.Valid == false ? "border-red-500" : "border-gray-300"))"
                                  placeholder="Type something, delete it, then blur" />
                    <FieldError ClassValue="@(_ => "text-sm text-red-600 mt-1")" />
                    <FieldDescription ClassValue="@(_ => "text-xs text-gray-500 mt-1")">
                        Error shows because field was "dirtied" (value changed)
                    </FieldDescription>
                </FieldRoot>
            </div>
        </div>
    </DemoSection>
</ComponentShowcase>

@code {
    private bool controlledDirty;
    private bool controlledTouched;
    private FieldRootActions? fieldActions;

    [Parameter]
    public bool IsWasmMode { get; set; }

    private async Task ValidateFieldImperatively()
    {
        if (fieldActions is not null)
        {
            await fieldActions.ValidateAsync();
        }
    }

    private string GetStateClasses(FieldRootState s)
    {
        var classes = new List<string>();
        if (s.Dirty) classes.Add("border-yellow-500");
        if (s.Touched) classes.Add("bg-blue-50");
        if (!classes.Any()) classes.Add("border-gray-300");
        return string.Join(' ', classes);
    }

    private Task<string[]?> ValidateRequired(object? value)
    {
        var str = value?.ToString() ?? string.Empty;
        if (string.IsNullOrWhiteSpace(str))
            return Task.FromResult<string[]?>(["This field is required"]);
        return Task.FromResult<string[]?>(null);
    }

    private Task<string[]?> ValidateMinLength(object? value)
    {
        var str = value?.ToString() ?? string.Empty;
        if (string.IsNullOrEmpty(str) || str.Length < 3)
            return Task.FromResult<string[]?>(["Must be at least 3 characters"]);
        return Task.FromResult<string[]?>(null);
    }

    private Task<string[]?> ValidateEmail(object? value)
    {
        var str = value?.ToString() ?? string.Empty;
        if (string.IsNullOrEmpty(str))
            return Task.FromResult<string[]?>(null);
        if (!str.Contains('@'))
            return Task.FromResult<string[]?>(["Invalid email format"]);
        return Task.FromResult<string[]?>(null);
    }

    private Task<string[]?> ValidateMultiple(object? value)
    {
        var str = value?.ToString() ?? string.Empty;
        if (string.IsNullOrEmpty(str))
            return Task.FromResult<string[]?>(null);

        var errors = new List<string>();
        if (str.Length < 8)
            errors.Add("Must be at least 8 characters");
        if (!str.Any(char.IsUpper))
            errors.Add("Must contain an uppercase letter");
        if (!str.Any(char.IsDigit))
            errors.Add("Must contain a number");

        return Task.FromResult<string[]?>(errors.Count > 0 ? errors.ToArray() : null);
    }

    private RenderFragment<RenderProps<FieldRootState>> RenderLabelAsSpan =>
        ctx => RenderUtilities.CreateElement("span", ctx);
}