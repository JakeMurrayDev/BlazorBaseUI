@typeparam TMetadata

<CascadingValue Value="listContext"
                IsFixed="true">
    @ChildContent
</CascadingValue>

@code {
    private readonly CompositeListContext<TMetadata> listContext = new();

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public EventCallback<IReadOnlyDictionary<int, TMetadata?>> OnMapChange { get; set; }

    protected override void OnInitialized()
    {
        listContext.MapChanged += HandleMapChanged;
    }

    private void HandleMapChanged()
    {
        if (OnMapChange.HasDelegate)
        {
            var map = new Dictionary<int, TMetadata?>();
            foreach (var element in listContext.Elements)
            {
                var metadata = listContext.GetMetadata(element);
                if (metadata != null)
                {
                    map[metadata.Index] = metadata.Data;
                }
            }

            InvokeAsync(() => OnMapChange.InvokeAsync(map));
        }
    }

    public void Dispose()
    {
        listContext.MapChanged -= HandleMapChanged;
    }
}