@using Microsoft.JSInterop
@implements IAsyncDisposable
@inject IJSRuntime JSRuntime

<RenderElement TState="object"
               Tag="div"
               Render="Render"
               ComponentAttributes="componentAttributes"
               ChildContent="ChildContent"
               @attributes="AdditionalAttributes"
               @ref="renderElementReference" />

@code {
    private readonly string defaultId = Guid.NewGuid().ToIdString();

    private Lazy<Task<IJSObjectReference>>? moduleTask;
    private bool hasRendered;
    private bool disposed;
    private RenderElement<object>? renderElementReference;
    private Dictionary<string, object> componentAttributes = new();

    private Lazy<Task<IJSObjectReference>> ModuleTask => moduleTask ??= new Lazy<Task<IJSObjectReference>>(() =>
        JSRuntime.InvokeAsync<IJSObjectReference>(
            "import", "./_content/BlazorBaseUI/blazor-baseui-portal.js").AsTask());

    /// <summary>
    /// Gets or sets a custom render fragment that replaces the default element.
    /// </summary>
    [Parameter]
    public RenderFragment<RenderProps<object>>? Render { get; set; }

    /// <summary>
    /// Gets or sets a CSS selector for the parent element to render the portal into.
    /// Defaults to <c>"body"</c>.
    /// </summary>
    [Parameter]
    public string Target { get; set; } = "body";

    /// <summary>
    /// Defines the child components of this instance.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Gets or sets a collection of additional attributes that will be applied to the created element.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public IReadOnlyDictionary<string, object>? AdditionalAttributes { get; set; }

    /// <summary>
    /// Gets or sets the associated <see cref="ElementReference"/>.
    /// </summary>
    public ElementReference? Element => renderElementReference?.Element;

    private string Id => AttributeUtilities.GetIdOrDefault(AdditionalAttributes, () => defaultId);

    /// <inheritdoc />
    protected override void OnInitialized()
    {
        BuildComponentAttributes();
    }

    /// <inheritdoc />
    protected override void OnParametersSet()
    {
        BuildComponentAttributes();
    }

    /// <inheritdoc />
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !disposed)
        {
            try
            {
                var module = await ModuleTask.Value;
                await module.InvokeVoidAsync("createPortal", Id, Target);
                hasRendered = true;
                BuildComponentAttributes();
                StateHasChanged();
            }
            catch (Exception ex) when (ex is JSDisconnectedException or TaskCanceledException)
            {
            }
        }
    }

    /// <inheritdoc />
    public async ValueTask DisposeAsync()
    {
        if (disposed)
        {
            return;
        }

        disposed = true;

        if (moduleTask?.IsValueCreated == true)
        {
            try
            {
                var module = await ModuleTask.Value;
                await module.InvokeVoidAsync("restorePortal", Id);
                await module.DisposeAsync();
            }
            catch (Exception ex) when (ex is JSDisconnectedException or TaskCanceledException)
            {
            }
        }
    }

    private void BuildComponentAttributes()
    {
        var attrs = new Dictionary<string, object>();

        attrs["data-blazor-base-ui-portal"] = string.Empty;
        attrs["id"] = Id;

        if (!hasRendered)
        {
            attrs["style"] = "display: none;";
        }

        componentAttributes = attrs;
    }
}
