@using System.Diagnostics.CodeAnalysis
@implements IDisposable

@if (Context?.ImageLoadingStatus != ImageLoadingStatus.Loaded && delayPassed)
{
    <span @ref="Element"
          @attributes="AdditionalAttributes">
        @ChildContent
    </span>
}

@code {
    private CancellationTokenSource? delayCts;
    private bool delayPassed;

    [CascadingParameter]
    private AvatarRootContext? Context { get; set; }

    [Parameter]
    public int? Delay { get; set; }

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    [DisallowNull]
    public ElementReference? Element { get; protected set; }

    protected override void OnInitialized()
    {
        if (Context is null)
        {
            throw new InvalidOperationException(
                "Base UI: AvatarRootContext is missing. Avatar parts must be placed within <AvatarRoot>.");
        }

        delayPassed = Delay is null;
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Delay is not null && !delayPassed)
        {
            delayCts?.Cancel();
            delayCts = new CancellationTokenSource();

            try
            {
                await Task.Delay(Delay.Value, delayCts.Token);
                delayPassed = true;
                StateHasChanged();
            }
            catch (TaskCanceledException)
            {
            }
        }
    }

    public void Dispose()
    {
        delayCts?.Cancel();
        delayCts?.Dispose();
    }
}